/*! @license
 * abyssa <https://github.com/AlexGalays/abyssa-js/>
 * Author: Alexandre Galays | MIT License
 * v1.2.16 (2013-12-23T17:02:05.933Z)
 */
!function(){var e=function(e,t,n,r){function a(e){return"[object String]"===Object.prototype.toString.call(e)}function o(){}function i(e){return e.reduce(function(e,t){return e[t]=1,e},{})}function u(e){var t=[];for(var n in e)t.push(e[n]);return t}function c(e){var t={};for(var n in e)t[n]=e[n];return t}function f(e,t){for(var n in t)e[n]=t[n]}function s(e){var t=0;for(var n in e)t++;return t}function l(e,t){var n,r={};e=e||{};for(n in e)e[n]!==t[n]&&(r[n]=1);for(n in t)e[n]!==t[n]&&(r[n]=1);return r}function d(){var e=window&&window.location;if(!e)throw new Error("Browser location object cannot be obtained.");return e}function h(e,t){return(t?"":"/")+e.replace(/^\/+/,"").replace(/^([^?]*?)\/+$/,"$1").replace(/\/+\?/,"?")}function p(e){e=e||d();var t=e.href.indexOf("#/");return h(t>-1?e.href.slice(t+2):e.pathname+e.search)}function v(e){var t;try{t=n(e())}catch(r){t=n.defer().reject(r)}return t}function m(e,t,n,r){function a(e,t){return f.then(function(){u||e()},function(e){u||t(e)})}function o(){u=!0}var i,u,c,f,s=[],d=l(n,r),h=e===t;return e&&(i=y(e,t,h,d),s=q(e,i,h)),c=q(t,i,h).reverse(),f=w(c,s,r).then(function(){u||g(c,s,r)}),A.newTransitionStarted(),{from:e,fromParams:n,to:t,toParams:r,then:a,cancel:o}}function w(e,t,r){return t.forEach(function(e){if(e.exitPrereqs)var t=e._exitPrereqs=v(function(){return e.exitPrereqs()}).then(function(n){e._exitPrereqs===t&&(e._exitPrereqs.value=n)},function(t){var r=new Error('Failed to resolve EXIT prereqs of state "'+e.fullName+'": '+(t?t.message||t:"(no cause)"));return r.inner=t,j(r),n.defer().reject(r)})}),e.forEach(function(e){if(e.enterPrereqs)var t=e._enterPrereqs=v(function(){return e.enterPrereqs(r)}).then(function(n){e._enterPrereqs===t&&(e._enterPrereqs.value=n)},function(t){var r=new Error('Failed to resolve ENTER prereqs of state "'+e.fullName+'": '+(t?t.message||t:"(no cause)"));return r.inner=t,j(r),n.defer().reject(r)})}),n.all(e.concat(t).map(function(e){return e._enterPrereqs||e._exitPrereqs}))}function g(e,t,n){t.forEach(function(e){e.exit(e._exitPrereqs&&e._exitPrereqs.value),e._exitPrereqs=null}),A.allowed=!0,e.forEach(function(e){e.enter(n,e._enterPrereqs&&e._enterPrereqs.value),e._enterPrereqs=null}),A.allowed=!1}function y(e,t,n,r){var a,o;if(n)[e].concat(e.parents).reverse().forEach(function(e){if(!a)for(var t in r)if(e.params[t]||e.queryParams[t]){a=e;break}});else for(var i=0;i<e.parents.length;i++)if(o=e.parents[i],t.parents.indexOf(o)>-1){a=o;break}return a}function P(e,t,n){var r=e.parents,a=Math.min(r.length,r.indexOf(t)+(n?1:0));return[e].concat(r.slice(0,a))}function q(e,t,n){var r=!t||n;return P(e,t||e.root,r)}function E(){function e(e,t){p.name=e,p.parent=t,p.parents=n(),p.children=r(),p.fullName=i(),p.root=p.parents[p.parents.length-1],p.async=_.Async,f(function(e,t){t.init(e,p)}),d=!0}function t(){for(var e=p.path,t=p.parent;t;)t.path&&(e=t.path+"/"+e),t=t.parent;return h(e)}function n(){for(var e=[],t=p.parent;t;)e.push(t),t=t.parent;return e}function r(){var e=[];for(var t in w)e.push(w[t]);return e}function a(e){var t={};for(var n in e)e[n]._isState&&(t[n]=e[n]);return t}function i(){return p.parents.reduceRight(function(e,t){return e+t.name+"."},"")+p.name}function u(e){var t={enter:1,exit:1,enterPrereqs:1,exitPrereqs:1},n={};for(var r in e)t[r]||e[r]._isState||(n[r]=e[r]);return n}function c(e,t){if(void 0!==t){if(void 0!==p.ownData[e])throw new Error("State "+p.fullName+" already has data with the key "+e);return p.ownData[e]=t,void 0}for(var n=p;void 0===n.ownData[e]&&n.parent;)n=n.parent;return n.ownData[e]}function f(e){for(var t in w)e(t,w[t])}function s(e,t){if(d)throw new Error("States can only be added before the Router is initialized");if(w[e])throw new Error("The state {0} already has a child state named {1}".replace("{0}",t.name).replace("{1}",e));w[e]=t}function l(){return p.fullName}var d,p={_isState:!0},v=x(arguments),m=v.options,w=a(v.options);return p.path=v.path,p.params=v.params,p.queryParams=v.queryParams,p.states=w,p.enter=m.enter||o,p.exit=m.exit||o,p.enterPrereqs=m.enterPrereqs,p.exitPrereqs=m.exitPrereqs,p.ownData=u(m),p.init=e,p.getFullPath=t,p.data=c,p.addState=s,p.toString=l,p}function x(e){var t,n={path:"",options:{},params:{},queryParams:{}},r=e[0],o=e[1];return 1===e.length?a(r)?n.path=r:n.options=r:2===e.length&&(n.path=r,n.options="object"==typeof o?o:{enter:o}),n.path=h(n.path,!0),t=n.path.indexOf("?"),-1!==t&&(n.queryParams=n.path.slice(t+1),n.path=n.path.slice(0,t),n.queryParams=i(n.queryParams.split("&"))),n.path=n.path.replace(/[\:\{][^\/]+/g,function(e){var t,r=e.charAt(e.length-1);return"}"===r||":"===r?(t=e.substring(1,e.length-1),n.params[t]=1,e):(t=e.substring(1),n.params[t]=1,"{"+t+"}")}),n}function S(n){function a(e,t){i(e,t)||(F&&(O("Cancelling existing transition from {0} to {1}",F.from,F.to),F.cancel(),I.transition.cancelled.dispatch(F.from,F.to,F.fromParams,F.toParams)),O!==o&&O("Starting transition from {0}:{1} to {2}:{3}",T,JSON.stringify(z),e,JSON.stringify(t)),I.transition.started.dispatch(T,e,z,t),F=m(T,e,z,t),F.then(function(){var n,a=T,o=z;T=e,z=t,F=null,C||V||(n=R,O("Pushing state: {0}",n),r.pushState(n,window.document&&window.document.title||"",n)),O("Transition from {0} to {1} completed",a,e),I.transition.completed.dispatch(a,T,o,z),V=!1},function(n){F=null,N("Transition from {0} to {1} failed: {2}",T,e,n),I.transition.failed.dispatch(T,e,z,t,n),V=!1}))}function i(e,t){var n,r,a;return F?(n=F.to,r=F.toParams):(n=T,r=z),a=l(r,t),e===n&&0===s(a)}function d(e){return!e||e.indexOf("/")>-1||e.indexOf("?")>-1}function v(e,t){O("State not found: {0}",e),Q.notFound?a(Q.notFound,d(e)?{pathQuery:e}:{name:e,params:t||{}}):j(new Error('State "'+e+'" could not be found.'))}function w(e,t){return O("Router init"),g(),e=!S.ignoreInitialURL&&p()||e||"",O("Initializing to state {0}",e),q(e,t),window.onpopstate=function(e){var t=e.state||p();O("Popped state: {0}",t),C=!0,E(t)},K=!0,k(I),I}function g(){y(function(e,t){t.init(e)}),P(function(e){$[e.fullName]=e,e.route=J.addRoute(e.getFullPath()+":?query:"),e.route.matched.add(function(){L=!0,a(e,_(e,arguments))})})}function y(e){for(var t in Q)e(t,Q[t])}function P(e){function t(n){n.forEach(function(n){n.children.length?t(n.children):e(n)})}t(u(Q))}function q(e,t){var n=d(e);O("Changing state to {0} {1}",e,n?"(path)":"(name)"),C=!1,n?E(e):x(e,t||{})}function E(e){R=h(e),L=!1,J.parse(R),L||v(R)}function x(e,t){var n=$[e];if(!n)return v(e,t);var r=n.route.interpolate(t);E(r)}function b(e,t){if(K)throw new Error("States can only be added before the Router is initialized");if(Q[e])throw new Error("A state already exist in the router with the name "+e);O("Adding state {0}",e),Q[e]=t}function _(e,t){var n,r=Array.prototype.slice.apply(t),a=r.pop(),o={};return e.getFullPath().replace(/(?:\{\w+?\})|(?:\:[^\:\/]+\:)/g,function(e){return n=e.slice(1,-1),o[n]=r.shift(),""}),a&&f(o,a),o}function A(e,t){var n={},r={},a=!1,o=$[e];if(!o)throw new Error("Cannot find state "+e);[o].concat(o.parents).forEach(function(e){f(r,e.queryParams)});for(var i in t)r[i]&&(n[i]=t[i],delete t[i],a=!0);return a&&(t.query=n),h(o.route.interpolate(t))}function D(){I.transition.ended.dispatch.apply(I.transition.ended,arguments)}var R,T,z,F,L,C,K,I={},Q=c(n),J=t.create(),V=!0,$={};return J.shouldTypecast=!0,J.ignoreState=!0,I.init=w,I.state=q,I.addState=b,I.link=A,I.transition={started:new e.Signal,ended:new e.Signal,completed:new e.Signal,failed:new e.Signal,cancelled:new e.Signal},I.initialized=new e.Signal,I.transition.completed.addOnce(function(e,t,n,r){I.initialized.dispatch(t,r)}),I.transition.completed.add(D),I.transition.failed.add(D),I.transition.cancelled.add(D),I}function b(e){if(e)throw"undefined"!=typeof console&&console.error(e),e}var _={};_.getParamDiff=l,_.getLocationObject=d,_.normalizePathQuery=h,_.getPathQuery=p;var A=function(){function e(e){if(!r.allowed)throw new Error("Async can only be called from within state.enter()");var t=n.defer();return a.push(t),n(e).then(function(e){a.indexOf(t)>-1&&t.resolve(e)},function(e){a.indexOf(t)>-1&&t.reject(e)}),t.promise}function t(){a.length=0}var r,a=[];return r={register:e,newTransitionStarted:t,allowed:!1}}();_.Async=A.register,_.State=E;var O=o,N=o;S.enableLogs=function(){function e(e){for(var t=e[0],n=Array.prototype.slice.call(e,1),r=0,a=n.length;a>r;r++)t=t.replace("{"+r+"}",n[r]);return t}O=function(){"undefined"!=typeof console&&console.log(e(arguments))},N=function(){"undefined"!=typeof console&&console.error(e(arguments))}};var j=b;S.setAsyncErrorHandler=function(e){var t=j;return j=e||b,t},_.Router=S;var k=function(e){function t(e){var t=e.which,n=e.button;return t||"undefined"==typeof n||(t=1&n?1:2&n?3:4&n?2:1),1===t}function n(e){for(;e;){if("A"===e.nodeName)return e;e=e.parentNode}}function r(t){var n=e.document.createElement("A");return n.href=t.href,n.protocol===a.protocol&&n.hostname===a.hostname&&(n.port||"80")===(a.port||"80")}if(e&&e.document){var a=d();return function(a,o){function i(o){var i=o||e.event,u=i.target||i.srcElement,c="defaultPrevented"in i?i.defaultPrevented:i.returnValue===!1;if(!(c||i.metaKey||i.ctrlKey||i.shiftKey||i.altKey)&&t(i)){var f=n(u);f&&f.getAttribute("href",2)&&!f.getAttribute("target")&&r(f)&&!/([a-z0-9_\-]+\:)?\/\/[^@]+@/.test(f.href)&&(i.preventDefault?i.preventDefault():i.returnValue=!1,a.state(p(f)))}}return o||(o=e.document),o.addEventListener?o.addEventListener("click",i):o.attachEvent&&o.attachEvent("onclick",i),function(){o.removeEventListener?o.removeEventListener("click",i):o.detachEvent&&o.detachEvent("onclick",i)}}}}(this);return _.interceptAnchorClicks=k,_};"function"==typeof define&&define.amd?define(["abyssa"],e):"undefined"!=typeof module&&module.exports?module.exports=e(require("signals"),require("crossroads"),require("when"),require("history")):window.Abyssa=e(window.signals,window.crossroads,window.when,window.history)}();