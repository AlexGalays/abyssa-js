;/** @license
 * abyssa <https://github.com/AlexGalays/abyssa-js/>
 * Author: Alexandre Galays | MIT License
 * v1.1.2 (2013-09-16T12:45:55.674Z)
 */
!function(){var t=function(t,n,e,r){function a(t){return"[object String]"===Object.prototype.toString.call(t)}function i(){}function o(t){return t.reduce(function(t,n){return t[n]=1,t},{})}function u(t){var n=[];for(var e in t)n.push(t[e]);return n}function c(t){var n={};for(var e in t)n[e]=t[e];return n}function f(t,n){for(var e in n)t[e]=n[e]}function s(t){var n=0;for(var e in t)n++;return n}function l(t,n,e,r){function a(t,n){return f.then(function(){u||t()},function(t){u||n(t)})}function i(){u=!0}var o,u,c,f,s=[],l=t===n;return t&&(o=p(t,n,l,r),s=m(t,o,l)),c=m(n,o,l).reverse(),f=d(c,s,e).then(function(){u||h(c,s,e)}),P.newTransitionStarted(),{from:t,to:n,toParams:e,then:a,cancel:i}}function d(t,n,r){return n.forEach(function(t){if(t.exitPrereqs)var n=t._exitPrereqs=e(t.exitPrereqs()).then(function(e){t._exitPrereqs===n&&(t._exitPrereqs.value=e)},function(){throw new Error("Failed to resolve EXIT prereqs of "+t.fullName)})}),t.forEach(function(t){if(t.enterPrereqs)var n=t._enterPrereqs=e(t.enterPrereqs(r)).then(function(e){t._enterPrereqs===n&&(t._enterPrereqs.value=e)},function(){throw new Error("Failed to resolve ENTER prereqs of "+t.fullName)})}),e.all(t.concat(n).map(function(t){return t._enterPrereqs||t._exitPrereqs}))}function h(t,n,e){n.forEach(function(t){t.exit(t._exitPrereqs&&t._exitPrereqs.value)}),P.allowed=!0,t.forEach(function(t){t.enter(e,t._enterPrereqs&&t._enterPrereqs.value)}),P.allowed=!1}function p(t,n,e,r){var a,i;if(e)t.parents.slice().reverse().forEach(function(t){for(var n in r)if(t.params[n]||t.queryParams[n]){a=t;break}});else for(var o=0;o<t.parents.length;o++)if(i=t.parents[o],n.parents.indexOf(i)>-1){a=i;break}return a}function v(t,n,e){var r=t.parents,a=Math.min(r.length,r.indexOf(n)+(e?1:0));return[t].concat(r.slice(0,a))}function m(t,n,e){var r=!n||e;return v(t,n||t.root,r)}function w(){function t(t,n){h.name=t,h.parent=n,h.parents=e(),h.children=r(),h.fullName=o(),h.root=h.parents[h.parents.length-1],h.async=q.Async,f(function(t,n){n.init(t,h)}),d=!0}function n(){for(var t=h.path,n=h.parent;n;)n.path&&(t=n.path+"/"+t),n=n.parent;return t}function e(){for(var t=[],n=h.parent;n;)t.push(n),n=n.parent;return t}function r(){var t=[];for(var n in m)t.push(m[n]);return t}function a(t){var n={};for(var e in t)t[e]._isState&&(n[e]=t[e]);return n}function o(){return h.parents.reduceRight(function(t,n){return t+n.name+"."},"")+h.name}function u(t){var n={enter:1,exit:1,enterPrereqs:1,exitPrereqs:1},e={};for(var r in t)n[r]||t[r]._isState||(e[r]=t[r]);return e}function c(t,n){if(void 0!==n){if(void 0!==h.ownData[t])throw new Error("State "+h.fullName+" already has data with the key "+t);return h.ownData[t]=n,void 0}for(var e=h;void 0===e.ownData[t]&&e.parent;)e=e.parent;return e.ownData[t]}function f(t){for(var n in m)t(n,m[n])}function s(t,n){if(d)throw new Error("States can only be added before the Router is initialized");if(m[t])throw new Error("The state {0} already has a child state named {1}".replace("{0}",n.name).replace("{1}",t));m[t]=n}function l(){return h.fullName}var d,h={_isState:!0},p=g(arguments),v=p.options,m=a(p.options);return h.path=p.path,h.params=p.params,h.queryParams=p.queryParams,h.states=m,h.enter=v.enter||i,h.exit=v.exit||i,h.enterPrereqs=v.enterPrereqs,h.exitPrereqs=v.exitPrereqs,h.ownData=u(v),h.init=t,h.fullPath=n,h.data=c,h.addState=s,h.toString=l,h}function g(t){var n,e,r={path:"",options:{},params:{},queryParams:{}},i=t[0],u=t[1];return 1===t.length?a(i)?r.path=i:r.options=i:2===t.length&&(r.path=i,r.options="object"==typeof u?u:{enter:u}),n=r.path.indexOf("?"),-1!==n&&(r.queryParams=r.path.slice(n+1),r.path=r.path.slice(0,n),r.queryParams=o(r.queryParams.split("&"))),r.path=r.path.replace(/:\w*/g,function(t){return e=t.substring(1),r.params[e]=1,"{"+e+"}"}),r}function y(t){function e(t,n){a(t,n)||(k&&(S("Cancelling existing transition from {0} to {1}",k.from,k.to),k.cancel(),L.transition.cancelled.dispatch(k.from,k.to)),S!==i&&S("Starting transition from {0}:{1} to {2}:{3}",R,JSON.stringify(T),t,JSON.stringify(n)),L.transition.started.dispatch(R,t),k=l(R,t,n,o(T,n)),k.then(function(){var e,a=R;R=t,T=n,k=null,j||J||(e=("/"+O).replace("//","/"),S("Pushing state: {0}",e),r.pushState(e,document.title,e)),S("Transition from {0} to {1} completed",a,t),L.transition.completed.dispatch(a,R),J=!1},function(n){k=null,x("Transition from {0} to {1} failed: {2}",R,t,n),L.transition.failed.dispatch(R,t)}))}function a(t,n){var e,r,a;return k?(e=k.to,r=k.toParams):(e=R,r=T),a=o(r,n),t===e&&0===s(a)}function o(t,n){var e,r={};t=t||{};for(e in t)t[e]!==n[e]&&(r[e]=1);for(e in n)t[e]!==n[e]&&(r[e]=1);return r}function d(t){if(S("State not found: {0}",t),!C.notFound)throw new Error('State "'+t+'" could not be found');e(C.notFound)}function h(t){S("Router init"),p();var n=!y.ignoreInitialURL&&b()||t||"";return S("Initializing to state {0}",n||'""'),w(n),window.onpopstate=function(t){var n=t.state||b();S("Popped state: {0}",n),j=!0,g(n)},F=!0,L}function p(){v(function(t,n){n.init(t)}),D={},m(function(t){D[t.fullName]=t,t.route=I.addRoute(t.fullPath()+":?query:"),t.route.matched.add(function(){z=!0,e(t,_(t,arguments))})})}function v(t){for(var n in C)t(n,C[n])}function m(t){function n(e){e.forEach(function(e){e.children.length?n(e.children):t(e)})}n(u(C))}function w(t,n){var e=t.indexOf(".")>-1||D[t];S("Changing state to {0}",t||'""'),j=!1,e?q(t,n||{}):g(t)}function g(t){O=t,z=!1,I.parse(t),z||d(t)}function q(t,n){var e=D[t];if(!e)return d(t);var r=e.route.interpolate(n);g(r)}function P(t,n){if(F)throw new Error("States can only be added before the Router is initialized");if(C[t])throw new Error("A state already exist in the router with the name "+t);S("Adding state {0}",t),C[t]=n}function b(){var t=location.href.indexOf("#/");return t>-1?location.href.slice(t+2):(location.pathname+location.search).slice(1)}function _(t,n){var e,r=Array.prototype.slice.apply(n),a=r.pop(),i={};return t.fullPath().replace(/\{\w*\}/g,function(t){return e=t.slice(1,-1),i[e]=r.shift(),""}),a&&f(i,a),i}function A(t,n){var e={},r={},a=!1,i=D[t];if(!i)throw new Error("Cannot find state "+t);[i].concat(i.parents).forEach(function(t){f(r,t.queryParams)});for(var o in n)r[o]&&(e[o]=n[o],delete n[o],a=!0);return a&&(n.query=e),"/"+i.route.interpolate(n).replace("/?","?")}function N(t,n){L.transition.ended.dispatch(t,n)}var O,R,T,k,D,z,j,F,L={},C=c(t),I=n.create(),J=!0;return I.shouldTypecast=!0,I.ignoreState=!0,E(L),L.init=h,L.state=w,L.addState=P,L.link=A,L.transition={started:new Signal,ended:new Signal,completed:new Signal,failed:new Signal,cancelled:new Signal},L.initialized=new Signal,L.transition.completed.addOnce(function(){L.initialized.dispatch()}),L.transition.completed.add(N),L.transition.failed.add(N),L.transition.cancelled.add(N),L}var q={},P=function(){function t(t){if(!r.allowed)throw new Error("Async can only be called from within state.enter()");var n=e.defer();return a.push(n),e(t).then(function(t){a.indexOf(n)>-1&&n.resolve(t)},function(t){a.indexOf(n)>-1&&n.reject(t)}),n.promise}function n(){a.length=0}var r,a=[];return r={register:t,newTransitionStarted:n,allowed:!1}}();q.Async=P.register,q.State=w;var S=i,x=i;y.enableLogs=function(){function t(t){for(var n=t[0],e=Array.prototype.slice.call(t,1),r=0,a=e.length;a>r;r++)n=n.replace("{"+r+"}",e[r]);return n}S=function(){console.log(t(arguments))},x=function(){console.error(t(arguments))}},q.Router=y;var E=function(t){function n(n){n=n||t.event;var e=n.which||n.button;return 1===e}function e(t){for(;t;){if("A"===t.nodeName)return t;t=t.parentNode}}if(t&&t.document&&t.location)return function(r){function a(a){if(!(a.defaultPrevented||a.metaKey||a.ctrlKey)&&n(a)){var i=e(a.target);i&&"_blank"!==i.getAttribute("target")&&i.hostname===t.location.hostname&&(a.preventDefault(),r.state(i.getAttribute("href")))}}t.document.addEventListener?t.document.addEventListener("click",a):t.document.attachEvent&&t.document.attachEvent("onclick",a)}}(this);return q};"function"==typeof define&&define.amd?define(["abyssa"],t):"undefined"!=typeof module&&module.exports?module.exports=t(require("signals"),require("crossroads"),require("when"),require("history")):window.Abyssa=t(window.signals,window.crossroads,window.when,window.history)}();