/*! @license
 * abyssa <https://github.com/AlexGalays/abyssa-js/>
 * Author: Alexandre Galays | MIT License
 * v1.2.8 (2013-11-07T09:28:59.779Z)
 */
!function(){var e=function(e,t,n,r){function a(e){return"[object String]"===Object.prototype.toString.call(e)}function o(){}function i(e){return e.reduce(function(e,t){return e[t]=1,e},{})}function u(e){var t=[];for(var n in e)t.push(e[n]);return t}function c(e){var t={};for(var n in e)t[n]=e[n];return t}function f(e,t){for(var n in t)e[n]=t[n]}function s(e){var t=0;for(var n in e)t++;return t}function l(e,t){var n,r={};e=e||{};for(n in e)e[n]!==t[n]&&(r[n]=1);for(n in t)e[n]!==t[n]&&(r[n]=1);return r}function d(){var e=window&&window.location;if(!e)throw new Error("Browser location object cannot be obtained.");return e}function p(e,t){return(t?"":"/")+e.replace(/^\/+/,"").replace(/\/+$/,"").replace(/\/+\?/,"?")}function h(e){e=e||d();var t=e.href.indexOf("#/");return p(t>-1?e.href.slice(t+2):e.pathname+e.search)}function v(e){var t;try{t=n(e())}catch(r){t=n.defer().reject(r)}return t}function m(e,t,n,r){function a(e,t){return f.then(function(){u||e()},function(e){u||t(e)})}function o(){u=!0}var i,u,c,f,s=[],d=l(n,r),p=e===t;return e&&(i=y(e,t,p,d),s=q(e,i,p)),c=q(t,i,p).reverse(),f=w(c,s,r).then(function(){u||g(c,s,r)}),_.newTransitionStarted(),{from:e,fromParams:n,to:t,toParams:r,then:a,cancel:o}}function w(e,t,r){return t.forEach(function(e){if(e.exitPrereqs)var t=e._exitPrereqs=v(function(){return e.exitPrereqs()}).then(function(n){e._exitPrereqs===t&&(e._exitPrereqs.value=n)},function(t){var n=new Error('Failed to resolve EXIT prereqs of state "'+e.fullName+'"');throw n.inner=t,n})}),e.forEach(function(e){if(e.enterPrereqs)var t=e._enterPrereqs=v(function(){return e.enterPrereqs(r)}).then(function(n){e._enterPrereqs===t&&(e._enterPrereqs.value=n)},function(t){var n=new Error('Failed to resolve ENTER prereqs of state "'+e.fullName+'"');throw n.inner=t,n})}),n.all(e.concat(t).map(function(e){return e._enterPrereqs||e._exitPrereqs}))}function g(e,t,n){t.forEach(function(e){e.exit(e._exitPrereqs&&e._exitPrereqs.value)}),_.allowed=!0,e.forEach(function(e){e.enter(n,e._enterPrereqs&&e._enterPrereqs.value)}),_.allowed=!1}function y(e,t,n,r){var a,o;if(n)e.parents.slice().reverse().forEach(function(e){for(var t in r)if(e.params[t]||e.queryParams[t]){a=e;break}});else for(var i=0;i<e.parents.length;i++)if(o=e.parents[i],t.parents.indexOf(o)>-1){a=o;break}return a}function P(e,t,n){var r=e.parents,a=Math.min(r.length,r.indexOf(t)+(n?1:0));return[e].concat(r.slice(0,a))}function q(e,t,n){var r=!t||n;return P(e,t||e.root,r)}function x(){function e(e,t){h.name=e,h.parent=t,h.parents=n(),h.children=r(),h.fullName=i(),h.root=h.parents[h.parents.length-1],h.async=b.Async,f(function(e,t){t.init(e,h)}),d=!0}function t(){for(var e=h.path,t=h.parent;t;)t.path&&(e=t.path+"/"+e),t=t.parent;return p(e)}function n(){for(var e=[],t=h.parent;t;)e.push(t),t=t.parent;return e}function r(){var e=[];for(var t in w)e.push(w[t]);return e}function a(e){var t={};for(var n in e)e[n]._isState&&(t[n]=e[n]);return t}function i(){return h.parents.reduceRight(function(e,t){return e+t.name+"."},"")+h.name}function u(e){var t={enter:1,exit:1,enterPrereqs:1,exitPrereqs:1},n={};for(var r in e)t[r]||e[r]._isState||(n[r]=e[r]);return n}function c(e,t){if(void 0!==t){if(void 0!==h.ownData[e])throw new Error("State "+h.fullName+" already has data with the key "+e);return h.ownData[e]=t,void 0}for(var n=h;void 0===n.ownData[e]&&n.parent;)n=n.parent;return n.ownData[e]}function f(e){for(var t in w)e(t,w[t])}function s(e,t){if(d)throw new Error("States can only be added before the Router is initialized");if(w[e])throw new Error("The state {0} already has a child state named {1}".replace("{0}",t.name).replace("{1}",e));w[e]=t}function l(){return h.fullName}var d,h={_isState:!0},v=E(arguments),m=v.options,w=a(v.options);return h.path=v.path,h.params=v.params,h.queryParams=v.queryParams,h.states=w,h.enter=m.enter||o,h.exit=m.exit||o,h.enterPrereqs=m.enterPrereqs,h.exitPrereqs=m.exitPrereqs,h.ownData=u(m),h.init=e,h.getFullPath=t,h.data=c,h.addState=s,h.toString=l,h}function E(e){var t,n={path:"",options:{},params:{},queryParams:{}},r=e[0],o=e[1];return 1===e.length?a(r)?n.path=r:n.options=r:2===e.length&&(n.path=r,n.options="object"==typeof o?o:{enter:o}),n.path=p(n.path,!0),t=n.path.indexOf("?"),-1!==t&&(n.queryParams=n.path.slice(t+1),n.path=n.path.slice(0,t),n.queryParams=i(n.queryParams.split("&"))),n.path=n.path.replace(/[\:\{][^\/]+/g,function(e){var t,r=e.charAt(e.length-1);return"}"===r||":"===r?(t=e.substring(1,e.length-1),n.params[t]=1,e):(t=e.substring(1),n.params[t]=1,"{"+t+"}")}),n}function S(n){function a(e,t){i(e,t)||(k&&(A("Cancelling existing transition from {0} to {1}",k.from,k.to),k.cancel(),C.transition.cancelled.dispatch(k.from,k.to,k.fromParams,k.toParams)),A!==o&&A("Starting transition from {0}:{1} to {2}:{3}",F,JSON.stringify(j),e,JSON.stringify(t)),C.transition.started.dispatch(F,e,j,t),k=m(F,e,j,t),k.then(function(){var n,a=F,o=j;F=e,j=t,k=null,K||V||(n=D,A("Pushing state: {0}",n),r.pushState(n,window.document&&window.document.title||"",n)),A("Transition from {0} to {1} completed",a,e),C.transition.completed.dispatch(a,F,o,j),V=!1},function(n){k=null,O("Transition from {0} to {1} failed: {2}",F,e,n),C.transition.failed.dispatch(F,e,j,t,n)}))}function i(e,t){var n,r,a;return k?(n=k.to,r=k.toParams):(n=F,r=j),a=l(r,t),e===n&&0===s(a)}function d(e){return!e||e.indexOf("/")>-1||e.indexOf("?")>-1}function v(e,t){if(A("State not found: {0}",e),!I.notFound)throw new Error('State "'+e+'" could not be found');a(I.notFound,d(e)?{pathQuery:e}:{name:e,params:t||{}})}function w(e,t){return A("Router init"),g(),e=!S.ignoreInitialURL&&h()||e||"",A("Initializing to state {0}",e),q(e,t),window.onpopstate=function(e){var t=e.state||h();A("Popped state: {0}",t),K=!0,x(t)},L=!0,N(C),C}function g(){y(function(e,t){t.init(e)}),P(function(e){B[e.fullName]=e,e.route=J.addRoute(e.getFullPath()+":?query:"),e.route.matched.add(function(){z=!0,a(e,_(e,arguments))})})}function y(e){for(var t in I)e(t,I[t])}function P(e){function t(n){n.forEach(function(n){n.children.length?t(n.children):e(n)})}t(u(I))}function q(e,t){var n=d(e);A("Changing state to {0} {1}",e,n?"(path)":"(name)"),K=!1,n?x(e):E(e,t||{})}function x(e){D=p(e),z=!1,J.parse(D),z||v(D)}function E(e,t){var n=B[e];if(!n)return v(e,t);var r=n.route.interpolate(t);x(r)}function b(e,t){if(L)throw new Error("States can only be added before the Router is initialized");if(I[e])throw new Error("A state already exist in the router with the name "+e);A("Adding state {0}",e),I[e]=t}function _(e,t){var n,r=Array.prototype.slice.apply(t),a=r.pop(),o={};return e.getFullPath().replace(/(?:\{\w+?\})|(?:\:[^\:\/]+\:)/g,function(e){return n=e.slice(1,-1),o[n]=r.shift(),""}),a&&f(o,a),o}function R(e,t){var n={},r={},a=!1,o=B[e];if(!o)throw new Error("Cannot find state "+e);[o].concat(o.parents).forEach(function(e){f(r,e.queryParams)});for(var i in t)r[i]&&(n[i]=t[i],delete t[i],a=!0);return a&&(t.query=n),p(o.route.interpolate(t))}function T(){C.transition.ended.dispatch.apply(C.transition.ended,arguments)}var D,F,j,k,z,K,L,C={},I=c(n),J=t.create(),V=!0,B={};return J.shouldTypecast=!0,J.ignoreState=!0,C.init=w,C.state=q,C.addState=b,C.link=R,C.transition={started:new e.Signal,ended:new e.Signal,completed:new e.Signal,failed:new e.Signal,cancelled:new e.Signal},C.initialized=new e.Signal,C.transition.completed.addOnce(function(e,t,n,r){C.initialized.dispatch(t,r)}),C.transition.completed.add(T),C.transition.failed.add(T),C.transition.cancelled.add(T),C}var b={},_=function(){function e(e){if(!r.allowed)throw new Error("Async can only be called from within state.enter()");var t=n.defer();return a.push(t),n(e).then(function(e){a.indexOf(t)>-1&&t.resolve(e)},function(e){a.indexOf(t)>-1&&t.reject(e)}),t.promise}function t(){a.length=0}var r,a=[];return r={register:e,newTransitionStarted:t,allowed:!1}}();b.Async=_.register,b.State=x;var A=o,O=o;S.enableLogs=function(){function e(e){for(var t=e[0],n=Array.prototype.slice.call(e,1),r=0,a=n.length;a>r;r++)t=t.replace("{"+r+"}",n[r]);return t}A=function(){"undefined"!=typeof console&&console.log(e(arguments))},O=function(){"undefined"!=typeof console&&console.error(e(arguments))}},b.Router=S;var N=function(e){function t(e){var t=e.which,n=e.button;return t||"undefined"==typeof n||(t=1&n?1:2&n?3:4&n?2:1),1===t}function n(e){for(;e;){if("A"===e.nodeName)return e;e=e.parentNode}}function r(t){var n=e.document.createElement("A");return n.href=t.href,n.protocol===a.protocol&&n.hostname===a.hostname&&(n.port||"80")===(a.port||"80")}if(e&&e.document){var a=d();return function(a){function o(o){var i=o||e.event,u=i.target||i.srcElement,c="defaultPrevented"in i?i.defaultPrevented:i.returnValue===!1;if(!(c||i.metaKey||i.ctrlKey||i.shiftKey||i.altKey)&&t(i)){var f=n(u);f&&f.getAttribute("href",2)&&!f.getAttribute("target")&&r(f)&&!/([a-z0-9_\-]+\:)?\/\/[^@]+@/.test(f.href)&&(i.preventDefault?i.preventDefault():i.returnValue=!1,a.state(h(f)))}}e.document.addEventListener?e.document.addEventListener("click",o):e.document.attachEvent&&e.document.attachEvent("onclick",o)}}}(this);return b};"function"==typeof define&&define.amd?define(["abyssa"],e):"undefined"!=typeof module&&module.exports?module.exports=e(require("signals"),require("crossroads"),require("when"),require("history")):window.Abyssa=e(window.signals,window.crossroads,window.when,window.history)}();