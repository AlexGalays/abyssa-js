;/** @license
 * abyssa <https://github.com/AlexGalays/abyssa-js/>
 * Author: Alexandre Galays | MIT License
 * v1.1.2 (2013-09-10T15:42:58.015Z)
 */
!function(){var n=function(n,t,e,r){function a(n){return"[object String]"==Object.prototype.toString.call(n)}function i(){}function o(n){return n.reduce(function(n,t){return n[t]=1,n},{})}function u(n){var t=[];for(var e in n)t.push(n[e]);return t}function f(n){var t={};for(var e in n)t[e]=n[e];return t}function c(n,t){for(var e in t)n[e]=t[e]}function s(n){var t=0;for(var e in n)t++;return t}function l(n,t,e,r){function a(n,t){return c.then(function(){u||n()},function(n){u||t(n)})}function i(){u=!0}var o,u,f,c,s=[],l=n==t;return n&&(o=h(n,t,l,r),s=m(n,o,l)),f=m(t,o,l).reverse(),c=d(f,s,e).then(function(){u||p(f,s,e)}),x.newTransitionStarted(),{from:n,to:t,toParams:e,then:a,cancel:i}}function d(n,t,r){return t.forEach(function(n){if(n.exitPrereqs)var t=n._exitPrereqs=e(n.exitPrereqs()).then(function(e){n._exitPrereqs==t&&(n._exitPrereqs.value=e)},function(){throw new Error("Failed to resolve EXIT prereqs of "+n.fullName)})}),n.forEach(function(n){if(n.enterPrereqs)var t=n._enterPrereqs=e(n.enterPrereqs(r)).then(function(e){n._enterPrereqs==t&&(n._enterPrereqs.value=e)},function(){throw new Error("Failed to resolve ENTER prereqs of "+n.fullName)})}),e.all(n.concat(t).map(function(n){return n._enterPrereqs||n._exitPrereqs}))}function p(n,t,e){t.forEach(function(n){n.exit(n._exitPrereqs&&n._exitPrereqs.value)}),x.allowed=!0,n.forEach(function(n){n.enter(e,n._enterPrereqs&&n._enterPrereqs.value)}),x.allowed=!1}function h(n,t,e,r){var a,i,o;if(e)n.parents.slice().reverse().forEach(function(n){for(o in r)if(n.params[o]||n.queryParams[o]){a=n;break}});else for(var u=0;u<n.parents.length;u++)if(i=n.parents[u],t.parents.indexOf(i)>-1){a=i;break}return a}function v(n,t,e){var r=n.parents,a=Math.min(r.length,r.indexOf(t)+(e?1:0));return[n].concat(r.slice(0,a))}function m(n,t,e){var r=!t||e;return v(n,t||n.root,r)}function w(){function n(n,t){p.name=n,p.parent=t,p.parents=e(),p.children=r(),p.fullName=o(),p.root=p.parents[p.parents.length-1],p.async=S.Async,c(function(n,t){t.init(n,p)}),d=!0}function t(){for(var n=p.path,t=p.parent;t;)t.path&&(n=t.path+"/"+n),t=t.parent;return n}function e(){for(var n=[],t=p.parent;t;)n.push(t),t=t.parent;return n}function r(){var n=[];for(var t in m)n.push(m[t]);return n}function a(n){var t={};for(var e in n)n[e]._isState&&(t[e]=n[e]);return t}function o(){return p.parents.reduceRight(function(n,t){return n+t.name+"."},"")+p.name}function u(n){var t={enter:1,exit:1,enterPrereqs:1,exitPrereqs:1},e={};for(var r in n)t[r]||n[r]._isState||(e[r]=n[r]);return e}function f(n,t){if(void 0!==t){if(void 0!==p.ownData[n])throw new Error("State "+p.fullName+" already has data with the key "+n);return p.ownData[n]=t,void 0}for(var e=p;void 0===e.ownData[n]&&e.parent;)e=e.parent;return e.ownData[n]}function c(n){for(var t in m)n(t,m[t])}function s(n,t){if(d)throw new Error("States can only be added before the Router is initialized");if(m[n])throw new Error("The state {0} already has a child state named {1}".replace("{0}",t.name).replace("{1}",n));m[n]=t}function l(){return p.fullName}var d,p={_isState:!0},h=g(arguments),v=h.options,m=a(h.options);return p.path=h.path,p.params=h.params,p.queryParams=h.queryParams,p.states=m,p.enter=v.enter||i,p.exit=v.exit||i,p.enterPrereqs=v.enterPrereqs,p.exitPrereqs=v.exitPrereqs,p.ownData=u(v),p.init=n,p.fullPath=t,p.data=f,p.addState=s,p.toString=l,p}function g(n){var t,e,r={path:"",options:{},params:{},queryParams:{}},i=n[0],u=n[1];return 1==n.length?a(i)?r.path=i:r.options=i:2==n.length&&(r.path=i,r.options="object"==typeof u?u:{enter:u}),t=r.path.indexOf("?"),-1!=t&&(r.queryParams=r.path.slice(t+1),r.path=r.path.slice(0,t),r.queryParams=o(r.queryParams.split("&"))),r.path=r.path.replace(/:\w*/g,function(n){return e=n.substring(1),r.params[e]=1,"{"+e+"}"}),r}function y(n){function e(n,t){a(n,t)||(T&&(E("Cancelling existing transition from {0} to {1}",T.from,T.to),T.cancel(),F.transition.cancelled.dispatch(T.from,T.to)),b&&E("Starting transition from {0}:{1} to {2}:{3}",O,JSON.stringify(R),n,JSON.stringify(t)),F.transition.started.dispatch(O,n),T=l(O,n,t,i(R,t)),T.then(function(){var e,a=O;O=n,R=t,T=null,z||L||(e=("/"+N).replace("//","/"),E("Pushing state: {0}",e),r.pushState(e,document.title,e)),E("Transition from {0} to {1} completed",a,n),F.transition.completed.dispatch(a,O),L=!1},function(t){T=null,logError("Transition from {0} to {1} failed: {2}",O,n,t),F.transition.failed.dispatch(O,n)}))}function a(n,t){var e,r,a;return T?(e=T.to,r=T.toParams):(e=O,r=R),a=i(r,t),n==e&&0==s(a)}function i(n,t){var e={},n=n||{};for(var r in n)n[r]!=t[r]&&(e[r]=1);for(var r in t)n[r]!=t[r]&&(e[r]=1);return e}function o(n){if(E("State not found: {0}",n),!C.notFound)throw new Error('State "'+n+'" could not be found');e(C.notFound)}function d(n){E("Router init"),p();var t=!y.ignoreInitialURL&&S()||n||"";return E("Initializing to state {0}",t||'""'),m(t),window.onpopstate=function(n){var t=n.state||S();E("Popped state: {0}",t),z=!0,w(t)},j=!0,F}function p(){h(function(n,t){t.init(n)}),k={},v(function(n){k[n.fullName]=n,n.route=I.addRoute(n.fullPath()+":?query:"),n.route.matched.add(function(){D=!0,e(n,x(n,arguments))})})}function h(n){for(var t in C)n(t,C[t])}function v(n){function t(e){e.forEach(function(e){e.children.length?t(e.children):n(e)})}t(u(C))}function m(n,t){var e=n.indexOf(".")>-1||k[n];E("Changing state to {0}",n||'""'),z=!1,e?g(n,t||{}):w(n)}function w(n){N=n,D=!1,I.parse(n),D||o(n)}function g(n,t){var e=k[n];if(!e)return o(n);var r=e.route.interpolate(t);w(r)}function P(n,t){if(j)throw new Error("States can only be added before the Router is initialized");if(C[n])throw new Error("A state already exist in the router with the name "+n);E("Adding state {0}",n),C[n]=t}function S(){var n=location.href.indexOf("#/");return n>-1?location.href.slice(n+2):(location.pathname+location.search).slice(1)}function x(n,t){var e,r=Array.prototype.slice.apply(t),a=r.pop(),i={};return n.fullPath().replace(/\{\w*\}/g,function(n){return e=n.slice(1,-1),i[e]=r.shift(),""}),a&&c(i,a),i}function _(n,t){var e={},r={},a=!1,i=k[n];if(!i)throw new Error("Cannot find state "+n);[i].concat(i.parents).forEach(function(n){c(r,n.queryParams)});for(var o in t)r[o]&&(e[o]=t[o],delete t[o],a=!0);return a&&(t.query=e),"/"+i.route.interpolate(t).replace("/?","?")}function A(n,t){F.transition.ended.dispatch(n,t)}var N,O,R,T,k,D,z,j,F={},C=f(n),I=t.create(),L=!0;return I.shouldTypecast=!0,I.ignoreState=!0,q(F),F.init=d,F.state=m,F.addState=P,F.link=_,F.transition={started:new Signal,ended:new Signal,completed:new Signal,failed:new Signal,cancelled:new Signal},F.initialized=new Signal,F.transition.completed.addOnce(function(){F.initialized.dispatch()}),F.transition.completed.add(A),F.transition.failed.add(A),F.transition.cancelled.add(A),F}function q(n){document.addEventListener("click",function(t){if(!(t.defaultPrevented||t.metaKey||t.ctrlKey||1==t.button)){var e=P(t.target);e&&"_blank"!=e.getAttribute("target")&&e.hostname==location.hostname&&(t.preventDefault(),n.state(e.getAttribute("href")))}})}function P(n){for(;n;){if("A"==n.nodeName)return n;n=n.parentNode}}var S={},x=function(){function n(n){if(!r.allowed)throw new Error("Async can only be called from within state.enter()");var t=e.defer();return a.push(t),e(n).then(function(n){a.indexOf(t)>-1&&t.resolve(n)},function(n){a.indexOf(t)>-1&&t.reject(n)}),t.promise}function t(){a.length=0}var r,a=[];return r={register:n,newTransitionStarted:t,allowed:!1}}();S.Async=x.register,S.State=w;var E=logError=i,b=!1;return y.enableLogs=function(){function n(n){for(var t=n[0],e=Array.prototype.slice.call(n,1),r=0,a=e.length;a>r;r++)t=t.replace("{"+r+"}",e[r]);return t}b=!0,E=function(){console.log(n(arguments))},logError=function(){console.error(n(arguments))}},S.Router=y,S};"function"==typeof define&&define.amd?define(["abyssa"],n):"undefined"!=typeof module&&module.exports?module.exports=n(require("signals"),require("crossroads"),require("when"),require("history")):window.Abyssa=n(window.signals,window.crossroads,window.when,window.history)}();