/*! @license
 * abyssa <https://github.com/AlexGalays/abyssa-js/>
 * Author: Alexandre Galays | MIT License
 * v1.1.4 (2013-09-16T16:31:26.827Z)
 */
!function(){var t=function(t,n,e,r){function a(t){return"[object String]"===Object.prototype.toString.call(t)}function i(){}function o(t){return t.reduce(function(t,n){return t[n]=1,t},{})}function u(t){var n=[];for(var e in t)n.push(t[e]);return n}function c(t){var n={};for(var e in t)n[e]=t[e];return n}function f(t,n){for(var e in n)t[e]=n[e]}function s(t){var n=0;for(var e in t)n++;return n}function l(t,n,e,r){function a(t,n){return f.then(function(){u||t()},function(t){u||n(t)})}function i(){u=!0}var o,u,c,f,s=[],l=t===n;return t&&(o=p(t,n,l,r),s=m(t,o,l)),c=m(n,o,l).reverse(),f=d(c,s,e).then(function(){u||h(c,s,e)}),P.newTransitionStarted(),{from:t,to:n,toParams:e,then:a,cancel:i}}function d(t,n,r){return n.forEach(function(t){if(t.exitPrereqs)var n=t._exitPrereqs=e(t.exitPrereqs()).then(function(e){t._exitPrereqs===n&&(t._exitPrereqs.value=e)},function(){throw new Error("Failed to resolve EXIT prereqs of "+t.fullName)})}),t.forEach(function(t){if(t.enterPrereqs)var n=t._enterPrereqs=e(t.enterPrereqs(r)).then(function(e){t._enterPrereqs===n&&(t._enterPrereqs.value=e)},function(){throw new Error("Failed to resolve ENTER prereqs of "+t.fullName)})}),e.all(t.concat(n).map(function(t){return t._enterPrereqs||t._exitPrereqs}))}function h(t,n,e){n.forEach(function(t){t.exit(t._exitPrereqs&&t._exitPrereqs.value)}),P.allowed=!0,t.forEach(function(t){t.enter(e,t._enterPrereqs&&t._enterPrereqs.value)}),P.allowed=!1}function p(t,n,e,r){var a,i;if(e)t.parents.slice().reverse().forEach(function(t){for(var n in r)if(t.params[n]||t.queryParams[n]){a=t;break}});else for(var o=0;o<t.parents.length;o++)if(i=t.parents[o],n.parents.indexOf(i)>-1){a=i;break}return a}function v(t,n,e){var r=t.parents,a=Math.min(r.length,r.indexOf(n)+(e?1:0));return[t].concat(r.slice(0,a))}function m(t,n,e){var r=!n||e;return v(t,n||t.root,r)}function w(){function t(t,n){h.name=t,h.parent=n,h.parents=e(),h.children=r(),h.fullName=o(),h.root=h.parents[h.parents.length-1],h.async=q.Async,f(function(t,n){n.init(t,h)}),d=!0}function n(){for(var t=h.path,n=h.parent;n;)n.path&&(t=n.path+"/"+t),n=n.parent;return t}function e(){for(var t=[],n=h.parent;n;)t.push(n),n=n.parent;return t}function r(){var t=[];for(var n in m)t.push(m[n]);return t}function a(t){var n={};for(var e in t)t[e]._isState&&(n[e]=t[e]);return n}function o(){return h.parents.reduceRight(function(t,n){return t+n.name+"."},"")+h.name}function u(t){var n={enter:1,exit:1,enterPrereqs:1,exitPrereqs:1},e={};for(var r in t)n[r]||t[r]._isState||(e[r]=t[r]);return e}function c(t,n){if(void 0!==n){if(void 0!==h.ownData[t])throw new Error("State "+h.fullName+" already has data with the key "+t);return h.ownData[t]=n,void 0}for(var e=h;void 0===e.ownData[t]&&e.parent;)e=e.parent;return e.ownData[t]}function f(t){for(var n in m)t(n,m[n])}function s(t,n){if(d)throw new Error("States can only be added before the Router is initialized");if(m[t])throw new Error("The state {0} already has a child state named {1}".replace("{0}",n.name).replace("{1}",t));m[t]=n}function l(){return h.fullName}var d,h={_isState:!0},p=g(arguments),v=p.options,m=a(p.options);return h.path=p.path,h.params=p.params,h.queryParams=p.queryParams,h.states=m,h.enter=v.enter||i,h.exit=v.exit||i,h.enterPrereqs=v.enterPrereqs,h.exitPrereqs=v.exitPrereqs,h.ownData=u(v),h.init=t,h.fullPath=n,h.data=c,h.addState=s,h.toString=l,h}function g(t){var n,e,r={path:"",options:{},params:{},queryParams:{}},i=t[0],u=t[1];return 1===t.length?a(i)?r.path=i:r.options=i:2===t.length&&(r.path=i,r.options="object"==typeof u?u:{enter:u}),n=r.path.indexOf("?"),-1!==n&&(r.queryParams=r.path.slice(n+1),r.path=r.path.slice(0,n),r.queryParams=o(r.queryParams.split("&"))),r.path=r.path.replace(/:\w*/g,function(t){return e=t.substring(1),r.params[e]=1,"{"+e+"}"}),r}function y(e){function a(t,n){o(t,n)||(D&&(S("Cancelling existing transition from {0} to {1}",D.from,D.to),D.cancel(),C.transition.cancelled.dispatch(D.from,D.to)),S!==i&&S("Starting transition from {0}:{1} to {2}:{3}",T,JSON.stringify(k),t,JSON.stringify(n)),C.transition.started.dispatch(T,t),D=l(T,t,n,d(k,n)),D.then(function(){var e,a=T;T=t,k=n,D=null,F||K||(e=("/"+R).replace("//","/"),S("Pushing state: {0}",e),r.pushState(e,document.title,e)),S("Transition from {0} to {1} completed",a,t),C.transition.completed.dispatch(a,T),K=!1},function(n){D=null,x("Transition from {0} to {1} failed: {2}",T,t,n),C.transition.failed.dispatch(T,t)}))}function o(t,n){var e,r,a;return D?(e=D.to,r=D.toParams):(e=T,r=k),a=d(r,n),t===e&&0===s(a)}function d(t,n){var e,r={};t=t||{};for(e in t)t[e]!==n[e]&&(r[e]=1);for(e in n)t[e]!==n[e]&&(r[e]=1);return r}function h(t){if(S("State not found: {0}",t),!I.notFound)throw new Error('State "'+t+'" could not be found');a(I.notFound)}function p(t){S("Router init"),v();var n=!y.ignoreInitialURL&&_()||t||"";return S("Initializing to state {0}",n||'""'),g(n),window.onpopstate=function(t){var n=t.state||_();S("Popped state: {0}",n),F=!0,q(n)},L=!0,C}function v(){m(function(t,n){n.init(t)}),z={},w(function(t){z[t.fullName]=t,t.route=J.addRoute(t.fullPath()+":?query:"),t.route.matched.add(function(){j=!0,a(t,A(t,arguments))})})}function m(t){for(var n in I)t(n,I[n])}function w(t){function n(e){e.forEach(function(e){e.children.length?n(e.children):t(e)})}n(u(I))}function g(t,n){var e=t.indexOf(".")>-1||z[t];S("Changing state to {0}",t||'""'),F=!1,e?P(t,n||{}):q(t)}function q(t){R=t,j=!1,J.parse(t),j||h(t)}function P(t,n){var e=z[t];if(!e)return h(t);var r=e.route.interpolate(n);q(r)}function b(t,n){if(L)throw new Error("States can only be added before the Router is initialized");if(I[t])throw new Error("A state already exist in the router with the name "+t);S("Adding state {0}",t),I[t]=n}function _(){var t=location.href.indexOf("#/");return t>-1?location.href.slice(t+2):(location.pathname+location.search).slice(1)}function A(t,n){var e,r=Array.prototype.slice.apply(n),a=r.pop(),i={};return t.fullPath().replace(/\{\w*\}/g,function(t){return e=t.slice(1,-1),i[e]=r.shift(),""}),a&&f(i,a),i}function N(t,n){var e={},r={},a=!1,i=z[t];if(!i)throw new Error("Cannot find state "+t);[i].concat(i.parents).forEach(function(t){f(r,t.queryParams)});for(var o in n)r[o]&&(e[o]=n[o],delete n[o],a=!0);return a&&(n.query=e),"/"+i.route.interpolate(n).replace("/?","?")}function O(t,n){C.transition.ended.dispatch(t,n)}var R,T,k,D,z,j,F,L,C={},I=c(e),J=n.create(),K=!0;return J.shouldTypecast=!0,J.ignoreState=!0,E(C),C.init=p,C.state=g,C.addState=b,C.link=N,C.transition={started:new t.Signal,ended:new t.Signal,completed:new t.Signal,failed:new t.Signal,cancelled:new t.Signal},C.initialized=new t.Signal,C.transition.completed.addOnce(function(){C.initialized.dispatch()}),C.transition.completed.add(O),C.transition.failed.add(O),C.transition.cancelled.add(O),C}var q={},P=function(){function t(t){if(!r.allowed)throw new Error("Async can only be called from within state.enter()");var n=e.defer();return a.push(n),e(t).then(function(t){a.indexOf(n)>-1&&n.resolve(t)},function(t){a.indexOf(n)>-1&&n.reject(t)}),n.promise}function n(){a.length=0}var r,a=[];return r={register:t,newTransitionStarted:n,allowed:!1}}();q.Async=P.register,q.State=w;var S=i,x=i;y.enableLogs=function(){function t(t){for(var n=t[0],e=Array.prototype.slice.call(t,1),r=0,a=e.length;a>r;r++)n=n.replace("{"+r+"}",e[r]);return n}S=function(){console.log(t(arguments))},x=function(){console.error(t(arguments))}},q.Router=y;var E=function(t){function n(n){n=n||t.event;var e=n.which||n.button;return 1===e}function e(t){for(;t;){if("A"===t.nodeName)return t;t=t.parentNode}}if(t&&t.document&&t.location)return function(r){function a(a){if(!(a.defaultPrevented||a.metaKey||a.ctrlKey)&&n(a)){var i=e(a.target);i&&"_blank"!==i.getAttribute("target")&&i.hostname===t.location.hostname&&(a.preventDefault(),r.state(i.getAttribute("href")))}}t.document.addEventListener?t.document.addEventListener("click",a):t.document.attachEvent&&t.document.attachEvent("onclick",a)}}(this);return q};"function"==typeof define&&define.amd?define(["abyssa"],t):"undefined"!=typeof module&&module.exports?module.exports=t(require("signals"),require("crossroads"),require("when"),require("history")):window.Abyssa=t(window.signals,window.crossroads,window.when,window.history)}();