;/** @license
 * abyssa <https://github.com/AlexGalays/abyssa-js/>
 * Author: Alexandre Galays | MIT License
 * v1.1.2 (2013-09-16T12:13:03.976Z)
 */
!function(){var t=function(t,n,e,r){function a(t){return"[object String]"==Object.prototype.toString.call(t)}function i(){}function o(t){return t.reduce(function(t,n){return t[n]=1,t},{})}function u(t){var n=[];for(var e in t)n.push(t[e]);return n}function c(t){var n={};for(var e in t)n[e]=t[e];return n}function f(t,n){for(var e in n)t[e]=n[e]}function s(t){var n=0;for(var e in t)n++;return n}function l(t,n,e,r){function a(t,n){return f.then(function(){u||t()},function(t){u||n(t)})}function i(){u=!0}var o,u,c,f,s=[],l=t==n;return t&&(o=p(t,n,l,r),s=m(t,o,l)),c=m(n,o,l).reverse(),f=d(c,s,e).then(function(){u||h(c,s,e)}),x.newTransitionStarted(),{from:t,to:n,toParams:e,then:a,cancel:i}}function d(t,n,r){return n.forEach(function(t){if(t.exitPrereqs)var n=t._exitPrereqs=e(t.exitPrereqs()).then(function(e){t._exitPrereqs==n&&(t._exitPrereqs.value=e)},function(){throw new Error("Failed to resolve EXIT prereqs of "+t.fullName)})}),t.forEach(function(t){if(t.enterPrereqs)var n=t._enterPrereqs=e(t.enterPrereqs(r)).then(function(e){t._enterPrereqs==n&&(t._enterPrereqs.value=e)},function(){throw new Error("Failed to resolve ENTER prereqs of "+t.fullName)})}),e.all(t.concat(n).map(function(t){return t._enterPrereqs||t._exitPrereqs}))}function h(t,n,e){n.forEach(function(t){t.exit(t._exitPrereqs&&t._exitPrereqs.value)}),x.allowed=!0,t.forEach(function(t){t.enter(e,t._enterPrereqs&&t._enterPrereqs.value)}),x.allowed=!1}function p(t,n,e,r){var a,i,o;if(e)t.parents.slice().reverse().forEach(function(t){for(o in r)if(t.params[o]||t.queryParams[o]){a=t;break}});else for(var u=0;u<t.parents.length;u++)if(i=t.parents[u],n.parents.indexOf(i)>-1){a=i;break}return a}function v(t,n,e){var r=t.parents,a=Math.min(r.length,r.indexOf(n)+(e?1:0));return[t].concat(r.slice(0,a))}function m(t,n,e){var r=!n||e;return v(t,n||t.root,r)}function w(){function t(t,n){h.name=t,h.parent=n,h.parents=e(),h.children=r(),h.fullName=o(),h.root=h.parents[h.parents.length-1],h.async=S.Async,f(function(t,n){n.init(t,h)}),d=!0}function n(){for(var t=h.path,n=h.parent;n;)n.path&&(t=n.path+"/"+t),n=n.parent;return t}function e(){for(var t=[],n=h.parent;n;)t.push(n),n=n.parent;return t}function r(){var t=[];for(var n in m)t.push(m[n]);return t}function a(t){var n={};for(var e in t)t[e]._isState&&(n[e]=t[e]);return n}function o(){return h.parents.reduceRight(function(t,n){return t+n.name+"."},"")+h.name}function u(t){var n={enter:1,exit:1,enterPrereqs:1,exitPrereqs:1},e={};for(var r in t)n[r]||t[r]._isState||(e[r]=t[r]);return e}function c(t,n){if(void 0!==n){if(void 0!==h.ownData[t])throw new Error("State "+h.fullName+" already has data with the key "+t);return h.ownData[t]=n,void 0}for(var e=h;void 0===e.ownData[t]&&e.parent;)e=e.parent;return e.ownData[t]}function f(t){for(var n in m)t(n,m[n])}function s(t,n){if(d)throw new Error("States can only be added before the Router is initialized");if(m[t])throw new Error("The state {0} already has a child state named {1}".replace("{0}",n.name).replace("{1}",t));m[t]=n}function l(){return h.fullName}var d,h={_isState:!0},p=g(arguments),v=p.options,m=a(p.options);return h.path=p.path,h.params=p.params,h.queryParams=p.queryParams,h.states=m,h.enter=v.enter||i,h.exit=v.exit||i,h.enterPrereqs=v.enterPrereqs,h.exitPrereqs=v.exitPrereqs,h.ownData=u(v),h.init=t,h.fullPath=n,h.data=c,h.addState=s,h.toString=l,h}function g(t){var n,e,r={path:"",options:{},params:{},queryParams:{}},i=t[0],u=t[1];return 1==t.length?a(i)?r.path=i:r.options=i:2==t.length&&(r.path=i,r.options="object"==typeof u?u:{enter:u}),n=r.path.indexOf("?"),-1!=n&&(r.queryParams=r.path.slice(n+1),r.path=r.path.slice(0,n),r.queryParams=o(r.queryParams.split("&"))),r.path=r.path.replace(/:\w*/g,function(t){return e=t.substring(1),r.params[e]=1,"{"+e+"}"}),r}function y(t){function e(t,n){a(t,n)||(T&&(b("Cancelling existing transition from {0} to {1}",T.from,T.to),T.cancel(),F.transition.cancelled.dispatch(T.from,T.to)),b!==i&&b("Starting transition from {0}:{1} to {2}:{3}",O,JSON.stringify(R),t,JSON.stringify(n)),F.transition.started.dispatch(O,t),T=l(O,t,n,o(R,n)),T.then(function(){var e,a=O;O=t,R=n,T=null,z||I||(e=("/"+N).replace("//","/"),b("Pushing state: {0}",e),r.pushState(e,document.title,e)),b("Transition from {0} to {1} completed",a,t),F.transition.completed.dispatch(a,O),I=!1},function(n){T=null,logError("Transition from {0} to {1} failed: {2}",O,t,n),F.transition.failed.dispatch(O,t)}))}function a(t,n){var e,r,a;return T?(e=T.to,r=T.toParams):(e=O,r=R),a=o(r,n),t==e&&0==s(a)}function o(t,n){var e={},t=t||{};for(var r in t)t[r]!=n[r]&&(e[r]=1);for(var r in n)t[r]!=n[r]&&(e[r]=1);return e}function d(t){if(b("State not found: {0}",t),!L.notFound)throw new Error('State "'+t+'" could not be found');e(L.notFound)}function h(t){b("Router init"),p();var n=!y.ignoreInitialURL&&S()||t||"";return b("Initializing to state {0}",n||'""'),w(n),window.onpopstate=function(t){var n=t.state||S();b("Popped state: {0}",n),z=!0,g(n)},j=!0,F}function p(){v(function(t,n){n.init(t)}),k={},m(function(t){k[t.fullName]=t,t.route=C.addRoute(t.fullPath()+":?query:"),t.route.matched.add(function(){D=!0,e(t,x(t,arguments))})})}function v(t){for(var n in L)t(n,L[n])}function m(t){function n(e){e.forEach(function(e){e.children.length?n(e.children):t(e)})}n(u(L))}function w(t,n){var e=t.indexOf(".")>-1||k[t];b("Changing state to {0}",t||'""'),z=!1,e?q(t,n||{}):g(t)}function g(t){N=t,D=!1,C.parse(t),D||d(t)}function q(t,n){var e=k[t];if(!e)return d(t);var r=e.route.interpolate(n);g(r)}function E(t,n){if(j)throw new Error("States can only be added before the Router is initialized");if(L[t])throw new Error("A state already exist in the router with the name "+t);b("Adding state {0}",t),L[t]=n}function S(){var t=location.href.indexOf("#/");return t>-1?location.href.slice(t+2):(location.pathname+location.search).slice(1)}function x(t,n){var e,r=Array.prototype.slice.apply(n),a=r.pop(),i={};return t.fullPath().replace(/\{\w*\}/g,function(t){return e=t.slice(1,-1),i[e]=r.shift(),""}),a&&f(i,a),i}function _(t,n){var e={},r={},a=!1,i=k[t];if(!i)throw new Error("Cannot find state "+t);[i].concat(i.parents).forEach(function(t){f(r,t.queryParams)});for(var o in n)r[o]&&(e[o]=n[o],delete n[o],a=!0);return a&&(n.query=e),"/"+i.route.interpolate(n).replace("/?","?")}function A(t,n){F.transition.ended.dispatch(t,n)}var N,O,R,T,k,D,z,j,F={},L=c(t),C=n.create(),I=!0;return C.shouldTypecast=!0,C.ignoreState=!0,P(F),F.init=h,F.state=w,F.addState=E,F.link=_,F.transition={started:new Signal,ended:new Signal,completed:new Signal,failed:new Signal,cancelled:new Signal},F.initialized=new Signal,F.transition.completed.addOnce(function(){F.initialized.dispatch()}),F.transition.completed.add(A),F.transition.failed.add(A),F.transition.cancelled.add(A),F}function q(t){t=t||window.event;var n=t.which||t.button;return 1==n}function P(t){function n(n){if(!(n.defaultPrevented||n.metaKey||n.ctrlKey)&&q(n)){var e=E(n.target);e&&"_blank"!=e.getAttribute("target")&&e.hostname==location.hostname&&(n.preventDefault(),t.state(e.getAttribute("href")))}}document.addEventListener?document.addEventListener("click",n):document.attachEvent&&document.attachEvent("onclick",n)}function E(t){for(;t;){if("A"==t.nodeName)return t;t=t.parentNode}}var S={},x=function(){function t(t){if(!r.allowed)throw new Error("Async can only be called from within state.enter()");var n=e.defer();return a.push(n),e(t).then(function(t){a.indexOf(n)>-1&&n.resolve(t)},function(t){a.indexOf(n)>-1&&n.reject(t)}),n.promise}function n(){a.length=0}var r,a=[];return r={register:t,newTransitionStarted:n,allowed:!1}}();S.Async=x.register,S.State=w;var b=logError=i;return y.enableLogs=function(){function t(t){for(var n=t[0],e=Array.prototype.slice.call(t,1),r=0,a=e.length;a>r;r++)n=n.replace("{"+r+"}",e[r]);return n}b=function(){console.log(t(arguments))},logError=function(){console.error(t(arguments))}},S.Router=y,S};"function"==typeof define&&define.amd?define(["abyssa"],t):"undefined"!=typeof module&&module.exports?module.exports=t(require("signals"),require("crossroads"),require("when"),require("history")):window.Abyssa=t(window.signals,window.crossroads,window.when,window.history)}();