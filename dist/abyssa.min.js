/*! @license
 * abyssa <https://github.com/AlexGalays/abyssa-js/>
 * Author: Alexandre Galays | MIT License
 * v1.2.13 (2013-11-28T09:57:47.157Z)
 */
!function(){var e=function(e,n,t,r){function a(e){return"[object String]"===Object.prototype.toString.call(e)}function o(){}function i(e){return e.reduce(function(e,n){return e[n]=1,e},{})}function u(e){var n=[];for(var t in e)n.push(e[t]);return n}function c(e){var n={};for(var t in e)n[t]=e[t];return n}function f(e,n){for(var t in n)e[t]=n[t]}function s(e){var n=0;for(var t in e)n++;return n}function l(e,n){var t,r={};e=e||{};for(t in e)e[t]!==n[t]&&(r[t]=1);for(t in n)e[t]!==n[t]&&(r[t]=1);return r}function d(){var e=window&&window.location;if(!e)throw new Error("Browser location object cannot be obtained.");return e}function h(e,n){return(n?"":"/")+e.replace(/^\/+/,"").replace(/^([^?]*?)\/+$/,"$1").replace(/\/+\?/,"?")}function p(e){e=e||d();var n=e.href.indexOf("#/");return h(n>-1?e.href.slice(n+2):e.pathname+e.search)}function v(e){var n;try{n=t(e())}catch(r){n=t.defer().reject(r)}return n}function m(e,n,t,r){function a(e,n){return f.then(function(){u||e()},function(e){u||n(e)})}function o(){u=!0}var i,u,c,f,s=[],d=l(t,r),h=e===n;return e&&(i=y(e,n,h,d),s=q(e,i,h)),c=q(n,i,h).reverse(),f=w(c,s,r).then(function(){u||g(c,s,r)}),A.newTransitionStarted(),{from:e,fromParams:t,to:n,toParams:r,then:a,cancel:o}}function w(e,n,r){return n.forEach(function(e){if(e.exitPrereqs)var n=e._exitPrereqs=v(function(){return e.exitPrereqs()}).then(function(t){e._exitPrereqs===n&&(e._exitPrereqs.value=t)},function(n){var t=new Error('Failed to resolve EXIT prereqs of state "'+e.fullName+'": '+(n?n.message||n:"(no cause)"));return t.inner=n,k(t)})}),e.forEach(function(e){if(e.enterPrereqs)var n=e._enterPrereqs=v(function(){return e.enterPrereqs(r)}).then(function(t){e._enterPrereqs===n&&(e._enterPrereqs.value=t)},function(n){var t=new Error('Failed to resolve ENTER prereqs of state "'+e.fullName+'": '+(n?n.message||n:"(no cause)"));return t.inner=n,k(t)})}),t.all(e.concat(n).map(function(e){return e._enterPrereqs||e._exitPrereqs}))}function g(e,n,t){n.forEach(function(e){e.exit(e._exitPrereqs&&e._exitPrereqs.value)}),A.allowed=!0,e.forEach(function(e){e.enter(t,e._enterPrereqs&&e._enterPrereqs.value)}),A.allowed=!1}function y(e,n,t,r){var a,o;if(t)e.parents.slice().reverse().forEach(function(e){for(var n in r)if(e.params[n]||e.queryParams[n]){a=e;break}});else for(var i=0;i<e.parents.length;i++)if(o=e.parents[i],n.parents.indexOf(o)>-1){a=o;break}return a}function P(e,n,t){var r=e.parents,a=Math.min(r.length,r.indexOf(n)+(t?1:0));return[e].concat(r.slice(0,a))}function q(e,n,t){var r=!n||t;return P(e,n||e.root,r)}function E(){function e(e,n){p.name=e,p.parent=n,p.parents=t(),p.children=r(),p.fullName=i(),p.root=p.parents[p.parents.length-1],p.async=_.Async,f(function(e,n){n.init(e,p)}),d=!0}function n(){for(var e=p.path,n=p.parent;n;)n.path&&(e=n.path+"/"+e),n=n.parent;return h(e)}function t(){for(var e=[],n=p.parent;n;)e.push(n),n=n.parent;return e}function r(){var e=[];for(var n in w)e.push(w[n]);return e}function a(e){var n={};for(var t in e)e[t]._isState&&(n[t]=e[t]);return n}function i(){return p.parents.reduceRight(function(e,n){return e+n.name+"."},"")+p.name}function u(e){var n={enter:1,exit:1,enterPrereqs:1,exitPrereqs:1},t={};for(var r in e)n[r]||e[r]._isState||(t[r]=e[r]);return t}function c(e,n){if(void 0!==n){if(void 0!==p.ownData[e])throw new Error("State "+p.fullName+" already has data with the key "+e);return p.ownData[e]=n,void 0}for(var t=p;void 0===t.ownData[e]&&t.parent;)t=t.parent;return t.ownData[e]}function f(e){for(var n in w)e(n,w[n])}function s(e,n){if(d)throw new Error("States can only be added before the Router is initialized");if(w[e])throw new Error("The state {0} already has a child state named {1}".replace("{0}",n.name).replace("{1}",e));w[e]=n}function l(){return p.fullName}var d,p={_isState:!0},v=x(arguments),m=v.options,w=a(v.options);return p.path=v.path,p.params=v.params,p.queryParams=v.queryParams,p.states=w,p.enter=m.enter||o,p.exit=m.exit||o,p.enterPrereqs=m.enterPrereqs,p.exitPrereqs=m.exitPrereqs,p.ownData=u(m),p.init=e,p.getFullPath=n,p.data=c,p.addState=s,p.toString=l,p}function x(e){var n,t={path:"",options:{},params:{},queryParams:{}},r=e[0],o=e[1];return 1===e.length?a(r)?t.path=r:t.options=r:2===e.length&&(t.path=r,t.options="object"==typeof o?o:{enter:o}),t.path=h(t.path,!0),n=t.path.indexOf("?"),-1!==n&&(t.queryParams=t.path.slice(n+1),t.path=t.path.slice(0,n),t.queryParams=i(t.queryParams.split("&"))),t.path=t.path.replace(/[\:\{][^\/]+/g,function(e){var n,r=e.charAt(e.length-1);return"}"===r||":"===r?(n=e.substring(1,e.length-1),t.params[n]=1,e):(n=e.substring(1),t.params[n]=1,"{"+n+"}")}),t}function S(t){function a(e,n){i(e,n)||(F&&(O("Cancelling existing transition from {0} to {1}",F.from,F.to),F.cancel(),I.transition.cancelled.dispatch(F.from,F.to,F.fromParams,F.toParams)),O!==o&&O("Starting transition from {0}:{1} to {2}:{3}",j,JSON.stringify(z),e,JSON.stringify(n)),I.transition.started.dispatch(j,e,z,n),F=m(j,e,z,n),F.then(function(){var t,a=j,o=z;j=e,z=n,F=null,C||V||(t=T,O("Pushing state: {0}",t),r.pushState(t,window.document&&window.document.title||"",t)),O("Transition from {0} to {1} completed",a,e),I.transition.completed.dispatch(a,j,o,z),V=!1},function(t){F=null,N("Transition from {0} to {1} failed: {2}",j,e,t),I.transition.failed.dispatch(j,e,z,n,t)}))}function i(e,n){var t,r,a;return F?(t=F.to,r=F.toParams):(t=j,r=z),a=l(r,n),e===t&&0===s(a)}function d(e){return!e||e.indexOf("/")>-1||e.indexOf("?")>-1}function v(e,n){return O("State not found: {0}",e),Q.notFound?(a(Q.notFound,d(e)?{pathQuery:e}:{name:e,params:n||{}}),void 0):k(new Error('State "'+e+'" could not be found.'))}function w(e,n){return O("Router init"),g(),e=!S.ignoreInitialURL&&p()||e||"",O("Initializing to state {0}",e),q(e,n),window.onpopstate=function(e){var n=e.state||p();O("Popped state: {0}",n),C=!0,E(n)},K=!0,D(I),I}function g(){y(function(e,n){n.init(e)}),P(function(e){$[e.fullName]=e,e.route=J.addRoute(e.getFullPath()+":?query:"),e.route.matched.add(function(){L=!0,a(e,_(e,arguments))})})}function y(e){for(var n in Q)e(n,Q[n])}function P(e){function n(t){t.forEach(function(t){t.children.length?n(t.children):e(t)})}n(u(Q))}function q(e,n){var t=d(e);O("Changing state to {0} {1}",e,t?"(path)":"(name)"),C=!1,t?E(e):x(e,n||{})}function E(e){T=h(e),L=!1,J.parse(T),L||v(T)}function x(e,n){var t=$[e];if(!t)return v(e,n);var r=t.route.interpolate(n);E(r)}function b(e,n){if(K)throw new Error("States can only be added before the Router is initialized");if(Q[e])throw new Error("A state already exist in the router with the name "+e);O("Adding state {0}",e),Q[e]=n}function _(e,n){var t,r=Array.prototype.slice.apply(n),a=r.pop(),o={};return e.getFullPath().replace(/(?:\{\w+?\})|(?:\:[^\:\/]+\:)/g,function(e){return t=e.slice(1,-1),o[t]=r.shift(),""}),a&&f(o,a),o}function A(e,n){var t={},r={},a=!1,o=$[e];if(!o)throw new Error("Cannot find state "+e);[o].concat(o.parents).forEach(function(e){f(r,e.queryParams)});for(var i in n)r[i]&&(t[i]=n[i],delete n[i],a=!0);return a&&(n.query=t),h(o.route.interpolate(n))}function R(){I.transition.ended.dispatch.apply(I.transition.ended,arguments)}var T,j,z,F,L,C,K,I={},Q=c(t),J=n.create(),V=!0,$={};return J.shouldTypecast=!0,J.ignoreState=!0,I.init=w,I.state=q,I.addState=b,I.link=A,I.transition={started:new e.Signal,ended:new e.Signal,completed:new e.Signal,failed:new e.Signal,cancelled:new e.Signal},I.initialized=new e.Signal,I.transition.completed.addOnce(function(e,n,t,r){I.initialized.dispatch(n,r)}),I.transition.completed.add(R),I.transition.failed.add(R),I.transition.cancelled.add(R),I}function b(e){if(e)throw"undefined"!=typeof console&&console.error(e),e}var _={};_.getParamDiff=l,_.getLocationObject=d,_.normalizePathQuery=h,_.getPathQuery=p;var A=function(){function e(e){if(!r.allowed)throw new Error("Async can only be called from within state.enter()");var n=t.defer();return a.push(n),t(e).then(function(e){a.indexOf(n)>-1&&n.resolve(e)},function(e){a.indexOf(n)>-1&&n.reject(e)}),n.promise}function n(){a.length=0}var r,a=[];return r={register:e,newTransitionStarted:n,allowed:!1}}();_.Async=A.register,_.State=E;var O=o,N=o;S.enableLogs=function(){function e(e){for(var n=e[0],t=Array.prototype.slice.call(e,1),r=0,a=t.length;a>r;r++)n=n.replace("{"+r+"}",t[r]);return n}O=function(){"undefined"!=typeof console&&console.log(e(arguments))},N=function(){"undefined"!=typeof console&&console.error(e(arguments))}};var k=b;S.setAsyncErrorHandler=function(e){k=e||b},_.Router=S;var D=function(e){function n(e){var n=e.which,t=e.button;return n||"undefined"==typeof t||(n=1&t?1:2&t?3:4&t?2:1),1===n}function t(e){for(;e;){if("A"===e.nodeName)return e;e=e.parentNode}}function r(n){var t=e.document.createElement("A");return t.href=n.href,t.protocol===a.protocol&&t.hostname===a.hostname&&(t.port||"80")===(a.port||"80")}if(e&&e.document){var a=d();return function(a,o){function i(o){var i=o||e.event,u=i.target||i.srcElement,c="defaultPrevented"in i?i.defaultPrevented:i.returnValue===!1;if(!(c||i.metaKey||i.ctrlKey||i.shiftKey||i.altKey)&&n(i)){var f=t(u);f&&f.getAttribute("href",2)&&!f.getAttribute("target")&&r(f)&&!/([a-z0-9_\-]+\:)?\/\/[^@]+@/.test(f.href)&&(i.preventDefault?i.preventDefault():i.returnValue=!1,a.state(p(f)))}}return o||(o=e.document),o.addEventListener?o.addEventListener("click",i):o.attachEvent&&o.attachEvent("onclick",i),function(){o.removeEventListener?o.removeEventListener("click",i):o.detachEvent&&o.detachEvent("onclick",i)}}}}(this);return _.interceptAnchorClicks=D,_};"function"==typeof define&&define.amd?define(["abyssa"],e):"undefined"!=typeof module&&module.exports?module.exports=e(require("signals"),require("crossroads"),require("when"),require("history")):window.Abyssa=e(window.signals,window.crossroads,window.when,window.history)}();