/*! @license
 * abyssa <https://github.com/AlexGalays/abyssa-js/>
 * Author: Alexandre Galays | MIT License
 * v1.2.0 (2013-10-03T13:10:03.831Z)
 */
!function(){var t=function(t,n,e,r){function a(t){return"[object String]"===Object.prototype.toString.call(t)}function i(){}function o(t){return t.reduce(function(t,n){return t[n]=1,t},{})}function u(t){var n=[];for(var e in t)n.push(t[e]);return n}function c(t){var n={};for(var e in t)n[e]=t[e];return n}function f(t,n){for(var e in n)t[e]=n[e]}function s(t){var n=0;for(var e in t)n++;return n}function l(t,n){var e,r={};t=t||{};for(e in t)t[e]!==n[e]&&(r[e]=1);for(e in n)t[e]!==n[e]&&(r[e]=1);return r}function d(t,n){return(n?"":"/")+t.replace(/^\/+/,"").replace(/\/+$/,"").replace(/\/+\?/,"?")}function p(t){t=t||window.location;var n=t.href.indexOf("#/");return d(t.pathname+"/"+(n>-1?t.href.slice(n+2):t.search))}function h(t,n,e,r){function a(t,n){return f.then(function(){u||t()},function(t){u||n(t)})}function i(){u=!0}var o,u,c,f,s=[],d=l(e,r),p=t===n;return t&&(o=w(t,n,p,d),s=y(t,o,p)),c=y(n,o,p).reverse(),f=m(c,s,r).then(function(){u||v(c,s,r)}),E.newTransitionStarted(),{from:t,fromParams:e,to:n,toParams:r,then:a,cancel:i}}function m(t,n,r){return n.forEach(function(t){if(t.exitPrereqs)var n=t._exitPrereqs=e(t.exitPrereqs()).then(function(e){t._exitPrereqs===n&&(t._exitPrereqs.value=e)},function(n){var e=new Error('Failed to resolve EXIT prereqs of state "'+t.fullName+'"');throw e.inner=n,e})}),t.forEach(function(t){if(t.enterPrereqs)var n=t._enterPrereqs=e(t.enterPrereqs(r)).then(function(e){t._enterPrereqs===n&&(t._enterPrereqs.value=e)},function(n){var e=new Error('Failed to resolve ENTER prereqs of state "'+t.fullName+'"');throw e.inner=n,e})}),e.all(t.concat(n).map(function(t){return t._enterPrereqs||t._exitPrereqs}))}function v(t,n,e){n.forEach(function(t){t.exit(t._exitPrereqs&&t._exitPrereqs.value)}),E.allowed=!0,t.forEach(function(t){t.enter(e,t._enterPrereqs&&t._enterPrereqs.value)}),E.allowed=!1}function w(t,n,e,r){var a,i;if(e)t.parents.slice().reverse().forEach(function(t){for(var n in r)if(t.params[n]||t.queryParams[n]){a=t;break}});else for(var o=0;o<t.parents.length;o++)if(i=t.parents[o],n.parents.indexOf(i)>-1){a=i;break}return a}function g(t,n,e){var r=t.parents,a=Math.min(r.length,r.indexOf(n)+(e?1:0));return[t].concat(r.slice(0,a))}function y(t,n,e){var r=!n||e;return g(t,n||t.root,r)}function P(){function t(t,n){h.name=t,h.parent=n,h.parents=e(),h.children=r(),h.fullName=o(),h.root=h.parents[h.parents.length-1],h.async=S.Async,f(function(t,n){n.init(t,h)}),p=!0}function n(){for(var t=h.path,n=h.parent;n;)n.path&&(t=n.path+"/"+t),n=n.parent;return d(t)}function e(){for(var t=[],n=h.parent;n;)t.push(n),n=n.parent;return t}function r(){var t=[];for(var n in w)t.push(w[n]);return t}function a(t){var n={};for(var e in t)t[e]._isState&&(n[e]=t[e]);return n}function o(){return h.parents.reduceRight(function(t,n){return t+n.name+"."},"")+h.name}function u(t){var n={enter:1,exit:1,enterPrereqs:1,exitPrereqs:1},e={};for(var r in t)n[r]||t[r]._isState||(e[r]=t[r]);return e}function c(t,n){if(void 0!==n){if(void 0!==h.ownData[t])throw new Error("State "+h.fullName+" already has data with the key "+t);return h.ownData[t]=n,void 0}for(var e=h;void 0===e.ownData[t]&&e.parent;)e=e.parent;return e.ownData[t]}function f(t){for(var n in w)t(n,w[n])}function s(t,n){if(p)throw new Error("States can only be added before the Router is initialized");if(w[t])throw new Error("The state {0} already has a child state named {1}".replace("{0}",n.name).replace("{1}",t));w[t]=n}function l(){return h.fullName}var p,h={_isState:!0},m=q(arguments),v=m.options,w=a(m.options);return h.path=m.path,h.params=m.params,h.queryParams=m.queryParams,h.states=w,h.enter=v.enter||i,h.exit=v.exit||i,h.enterPrereqs=v.enterPrereqs,h.exitPrereqs=v.exitPrereqs,h.ownData=u(v),h.init=t,h.getFullPath=n,h.data=c,h.addState=s,h.toString=l,h}function q(t){var n,e={path:"",options:{},params:{},queryParams:{}},r=t[0],i=t[1];return 1===t.length?a(r)?e.path=r:e.options=r:2===t.length&&(e.path=r,e.options="object"==typeof i?i:{enter:i}),e.path=d(e.path,!0),n=e.path.indexOf("?"),-1!==n&&(e.queryParams=e.path.slice(n+1),e.path=e.path.slice(0,n),e.queryParams=o(e.queryParams.split("&"))),e.path=e.path.replace(/[\:\{][^\/]+/g,function(t){var n,r=t.charAt(t.length-1);return"}"===r||":"===r?(n=t.substring(1,t.length-1),e.params[n]=1,t):(n=t.substring(1),e.params[n]=1,"{"+n+"}")}),e}function x(e){function a(t,n){o(t,n)||(D&&(b("Cancelling existing transition from {0} to {1}",D.from,D.to),D.cancel(),I.transition.cancelled.dispatch(D.from,D.to,D.fromParams,D.toParams)),b!==i&&b("Starting transition from {0}:{1} to {2}:{3}",k,JSON.stringify(z),t,JSON.stringify(n)),I.transition.started.dispatch(k,t,z,n),D=h(k,t,z,n),D.then(function(){var e,a=k,i=z;k=t,z=n,D=null,L||M||(e=F,b("Pushing state: {0}",e),r.pushState(e,window.document&&window.document.title||"",e)),b("Transition from {0} to {1} completed",a,t),I.transition.completed.dispatch(a,k,i,z),M=!1},function(e){D=null,_("Transition from {0} to {1} failed: {2}",k,t,e),I.transition.failed.dispatch(k,t,z,n)}))}function o(t,n){var e,r,a;return D?(e=D.to,r=D.toParams):(e=k,r=z),a=l(r,n),t===e&&0===s(a)}function m(t){return!t||t.indexOf("/")>-1||t.indexOf("?")>-1}function v(t,n){if(b("State not found: {0}",t),!J.notFound)throw new Error('State "'+t+'" could not be found');a(J.notFound,m(t)?{pathQuery:t}:{name:t,params:n||{}})}function w(t,n){return b("Router init"),g(),t=!x.ignoreInitialURL&&p()||t||"",b("Initializing to state {0}",t),q(t,n),window.onpopstate=function(t){var n=t.state||p();b("Popped state: {0}",n),L=!0,S(n)},C=!0,O(I),I}function g(){y(function(t,n){n.init(t)}),P(function(t){Q[t.fullName]=t,t.route=K.addRoute(t.getFullPath()+":?query:"),t.route.matched.add(function(){j=!0,a(t,N(t,arguments))})})}function y(t){for(var n in J)t(n,J[n])}function P(t){function n(e){e.forEach(function(e){e.children.length?n(e.children):t(e)})}n(u(J))}function q(t,n){var e=m(t);b("Changing state to {0} {1}",t,e?"(path)":"(name)"),L=!1,e?S(t):E(t,n||{})}function S(t){F=d(t),j=!1,K.parse(F),j||v(F)}function E(t,n){var e=Q[t];if(!e)return v(t,n);var r=e.route.interpolate(n);S(r)}function A(t,n){if(C)throw new Error("States can only be added before the Router is initialized");if(J[t])throw new Error("A state already exist in the router with the name "+t);b("Adding state {0}",t),J[t]=n}function N(t,n){var e,r=Array.prototype.slice.apply(n),a=r.pop(),i={};return t.getFullPath().replace(/(?:\{\w+?\})|(?:\:[^\:\/]+\:)/g,function(t){return e=t.slice(1,-1),i[e]=r.shift(),""}),a&&f(i,a),i}function R(t,n){var e={},r={},a=!1,i=Q[t];if(!i)throw new Error("Cannot find state "+t);[i].concat(i.parents).forEach(function(t){f(r,t.queryParams)});for(var o in n)r[o]&&(e[o]=n[o],delete n[o],a=!0);return a&&(n.query=e),d(i.route.interpolate(n))}function T(){I.transition.ended.dispatch.apply(I.transition.ended,arguments)}var F,k,z,D,j,L,C,I={},J=c(e),K=n.create(),M=!0,Q={};return K.shouldTypecast=!0,K.ignoreState=!0,I.init=w,I.state=q,I.addState=A,I.link=R,I.transition={started:new t.Signal,ended:new t.Signal,completed:new t.Signal,failed:new t.Signal,cancelled:new t.Signal},I.initialized=new t.Signal,I.transition.completed.addOnce(function(t,n,e,r){I.initialized.dispatch(n,r)}),I.transition.completed.add(T),I.transition.failed.add(T),I.transition.cancelled.add(T),I}var S={},E=function(){function t(t){if(!r.allowed)throw new Error("Async can only be called from within state.enter()");var n=e.defer();return a.push(n),e(t).then(function(t){a.indexOf(n)>-1&&n.resolve(t)},function(t){a.indexOf(n)>-1&&n.reject(t)}),n.promise}function n(){a.length=0}var r,a=[];return r={register:t,newTransitionStarted:n,allowed:!1}}();S.Async=E.register,S.State=P;var b=i,_=i;x.enableLogs=function(){function t(t){for(var n=t[0],e=Array.prototype.slice.call(t,1),r=0,a=e.length;a>r;r++)n=n.replace("{"+r+"}",e[r]);return n}b=function(){"undefined"!=typeof console&&console.log(t(arguments))},_=function(){"undefined"!=typeof console&&console.error(t(arguments))}},S.Router=x;var O=function(t){function n(n){n=n||t.event;var e=n.which||n.button;return 1===e}function e(t){for(;t;){if("A"===t.nodeName)return t;t=t.parentNode}}if(t&&t.document&&t.location)return function(r){function a(a){if(!(a.defaultPrevented||a.metaKey||a.ctrlKey)&&n(a)){var i=e(a.target);!i||i.getAttribute("target")||i.host!==t.location.host||i.protocol!==t.location.protocol||/([a-z0-9_\-]+\:)?\/\/[^@]+@/.test(i.href)||(a.preventDefault(),r.state(p(i)))}}t.document.addEventListener?t.document.addEventListener("click",a):t.document.attachEvent&&t.document.attachEvent("onclick",a)}}(this);return S};"function"==typeof define&&define.amd?define(["abyssa"],t):"undefined"!=typeof module&&module.exports?module.exports=t(require("signals"),require("crossroads"),require("when"),require("history")):window.Abyssa=t(window.signals,window.crossroads,window.when,window.history)}();