/*! @license
 * abyssa <https://github.com/AlexGalays/abyssa-js/>
 * Author: Alexandre Galays | MIT License
 * v1.2.11 (2013-11-15T07:32:21.637Z)
 */
!function(){var e=function(e,t,n,r){function a(e){return"[object String]"===Object.prototype.toString.call(e)}function i(){}function o(e){return e.reduce(function(e,t){return e[t]=1,e},{})}function u(e){var t=[];for(var n in e)t.push(e[n]);return t}function c(e){var t={};for(var n in e)t[n]=e[n];return t}function f(e,t){for(var n in t)e[n]=t[n]}function s(e){var t=0;for(var n in e)t++;return t}function l(e,t){var n,r={};e=e||{};for(n in e)e[n]!==t[n]&&(r[n]=1);for(n in t)e[n]!==t[n]&&(r[n]=1);return r}function d(){var e=window&&window.location;if(!e)throw new Error("Browser location object cannot be obtained.");return e}function h(e,t){return(t?"":"/")+e.replace(/^\/+/,"").replace(/^([^?]*?)\/+$/,"$1").replace(/\/+\?/,"?")}function p(e){e=e||d();var t=e.href.indexOf("#/");return h(t>-1?e.href.slice(t+2):e.pathname+e.search)}function v(e){var t;try{t=n(e())}catch(r){t=n.defer().reject(r)}return t}function m(e,t,n,r){function a(e,t){return f.then(function(){u||e()},function(e){u||t(e)})}function i(){u=!0}var o,u,c,f,s=[],d=l(n,r),h=e===t;return e&&(o=y(e,t,h,d),s=q(e,o,h)),c=q(t,o,h).reverse(),f=w(c,s,r).then(function(){u||g(c,s,r)}),_.newTransitionStarted(),{from:e,fromParams:n,to:t,toParams:r,then:a,cancel:i}}function w(e,t,r){return t.forEach(function(e){if(e.exitPrereqs)var t=e._exitPrereqs=v(function(){return e.exitPrereqs()}).then(function(n){e._exitPrereqs===t&&(e._exitPrereqs.value=n)},function(t){var n=new Error('Failed to resolve EXIT prereqs of state "'+e.fullName+'"');throw n.inner=t,n})}),e.forEach(function(e){if(e.enterPrereqs)var t=e._enterPrereqs=v(function(){return e.enterPrereqs(r)}).then(function(n){e._enterPrereqs===t&&(e._enterPrereqs.value=n)},function(t){var n=new Error('Failed to resolve ENTER prereqs of state "'+e.fullName+'"');throw n.inner=t,n})}),n.all(e.concat(t).map(function(e){return e._enterPrereqs||e._exitPrereqs}))}function g(e,t,n){t.forEach(function(e){e.exit(e._exitPrereqs&&e._exitPrereqs.value)}),_.allowed=!0,e.forEach(function(e){e.enter(n,e._enterPrereqs&&e._enterPrereqs.value)}),_.allowed=!1}function y(e,t,n,r){var a,i;if(n)e.parents.slice().reverse().forEach(function(e){for(var t in r)if(e.params[t]||e.queryParams[t]){a=e;break}});else for(var o=0;o<e.parents.length;o++)if(i=e.parents[o],t.parents.indexOf(i)>-1){a=i;break}return a}function P(e,t,n){var r=e.parents,a=Math.min(r.length,r.indexOf(t)+(n?1:0));return[e].concat(r.slice(0,a))}function q(e,t,n){var r=!t||n;return P(e,t||e.root,r)}function E(){function e(e,t){p.name=e,p.parent=t,p.parents=n(),p.children=r(),p.fullName=o(),p.root=p.parents[p.parents.length-1],p.async=b.Async,f(function(e,t){t.init(e,p)}),d=!0}function t(){for(var e=p.path,t=p.parent;t;)t.path&&(e=t.path+"/"+e),t=t.parent;return h(e)}function n(){for(var e=[],t=p.parent;t;)e.push(t),t=t.parent;return e}function r(){var e=[];for(var t in w)e.push(w[t]);return e}function a(e){var t={};for(var n in e)e[n]._isState&&(t[n]=e[n]);return t}function o(){return p.parents.reduceRight(function(e,t){return e+t.name+"."},"")+p.name}function u(e){var t={enter:1,exit:1,enterPrereqs:1,exitPrereqs:1},n={};for(var r in e)t[r]||e[r]._isState||(n[r]=e[r]);return n}function c(e,t){if(void 0!==t){if(void 0!==p.ownData[e])throw new Error("State "+p.fullName+" already has data with the key "+e);return p.ownData[e]=t,void 0}for(var n=p;void 0===n.ownData[e]&&n.parent;)n=n.parent;return n.ownData[e]}function f(e){for(var t in w)e(t,w[t])}function s(e,t){if(d)throw new Error("States can only be added before the Router is initialized");if(w[e])throw new Error("The state {0} already has a child state named {1}".replace("{0}",t.name).replace("{1}",e));w[e]=t}function l(){return p.fullName}var d,p={_isState:!0},v=x(arguments),m=v.options,w=a(v.options);return p.path=v.path,p.params=v.params,p.queryParams=v.queryParams,p.states=w,p.enter=m.enter||i,p.exit=m.exit||i,p.enterPrereqs=m.enterPrereqs,p.exitPrereqs=m.exitPrereqs,p.ownData=u(m),p.init=e,p.getFullPath=t,p.data=c,p.addState=s,p.toString=l,p}function x(e){var t,n={path:"",options:{},params:{},queryParams:{}},r=e[0],i=e[1];return 1===e.length?a(r)?n.path=r:n.options=r:2===e.length&&(n.path=r,n.options="object"==typeof i?i:{enter:i}),n.path=h(n.path,!0),t=n.path.indexOf("?"),-1!==t&&(n.queryParams=n.path.slice(t+1),n.path=n.path.slice(0,t),n.queryParams=o(n.queryParams.split("&"))),n.path=n.path.replace(/[\:\{][^\/]+/g,function(e){var t,r=e.charAt(e.length-1);return"}"===r||":"===r?(t=e.substring(1,e.length-1),n.params[t]=1,e):(t=e.substring(1),n.params[t]=1,"{"+t+"}")}),n}function S(n){function a(e,t){o(e,t)||(z&&(A("Cancelling existing transition from {0} to {1}",z.from,z.to),z.cancel(),K.transition.cancelled.dispatch(z.from,z.to,z.fromParams,z.toParams)),A!==i&&A("Starting transition from {0}:{1} to {2}:{3}",T,JSON.stringify(j),e,JSON.stringify(t)),K.transition.started.dispatch(T,e,j,t),z=m(T,e,j,t),z.then(function(){var n,a=T,i=j;T=e,j=t,z=null,L||J||(n=R,A("Pushing state: {0}",n),r.pushState(n,window.document&&window.document.title||"",n)),A("Transition from {0} to {1} completed",a,e),K.transition.completed.dispatch(a,T,i,j),J=!1},function(n){z=null,O("Transition from {0} to {1} failed: {2}",T,e,n),K.transition.failed.dispatch(T,e,j,t,n)}))}function o(e,t){var n,r,a;return z?(n=z.to,r=z.toParams):(n=T,r=j),a=l(r,t),e===n&&0===s(a)}function d(e){return!e||e.indexOf("/")>-1||e.indexOf("?")>-1}function v(e,t){if(A("State not found: {0}",e),!I.notFound)throw new Error('State "'+e+'" could not be found');a(I.notFound,d(e)?{pathQuery:e}:{name:e,params:t||{}})}function w(e,t){return A("Router init"),g(),e=!S.ignoreInitialURL&&p()||e||"",A("Initializing to state {0}",e),q(e,t),window.onpopstate=function(e){var t=e.state||p();A("Popped state: {0}",t),L=!0,E(t)},C=!0,N(K),K}function g(){y(function(e,t){t.init(e)}),P(function(e){V[e.fullName]=e,e.route=Q.addRoute(e.getFullPath()+":?query:"),e.route.matched.add(function(){F=!0,a(e,_(e,arguments))})})}function y(e){for(var t in I)e(t,I[t])}function P(e){function t(n){n.forEach(function(n){n.children.length?t(n.children):e(n)})}t(u(I))}function q(e,t){var n=d(e);A("Changing state to {0} {1}",e,n?"(path)":"(name)"),L=!1,n?E(e):x(e,t||{})}function E(e){R=h(e),F=!1,Q.parse(R),F||v(R)}function x(e,t){var n=V[e];if(!n)return v(e,t);var r=n.route.interpolate(t);E(r)}function b(e,t){if(C)throw new Error("States can only be added before the Router is initialized");if(I[e])throw new Error("A state already exist in the router with the name "+e);A("Adding state {0}",e),I[e]=t}function _(e,t){var n,r=Array.prototype.slice.apply(t),a=r.pop(),i={};return e.getFullPath().replace(/(?:\{\w+?\})|(?:\:[^\:\/]+\:)/g,function(e){return n=e.slice(1,-1),i[n]=r.shift(),""}),a&&f(i,a),i}function k(e,t){var n={},r={},a=!1,i=V[e];if(!i)throw new Error("Cannot find state "+e);[i].concat(i.parents).forEach(function(e){f(r,e.queryParams)});for(var o in t)r[o]&&(n[o]=t[o],delete t[o],a=!0);return a&&(t.query=n),h(i.route.interpolate(t))}function D(){K.transition.ended.dispatch.apply(K.transition.ended,arguments)}var R,T,j,z,F,L,C,K={},I=c(n),Q=t.create(),J=!0,V={};return Q.shouldTypecast=!0,Q.ignoreState=!0,K.init=w,K.state=q,K.addState=b,K.link=k,K.transition={started:new e.Signal,ended:new e.Signal,completed:new e.Signal,failed:new e.Signal,cancelled:new e.Signal},K.initialized=new e.Signal,K.transition.completed.addOnce(function(e,t,n,r){K.initialized.dispatch(t,r)}),K.transition.completed.add(D),K.transition.failed.add(D),K.transition.cancelled.add(D),K}var b={};b.getParamDiff=l,b.getLocationObject=d,b.normalizePathQuery=h,b.getPathQuery=p;var _=function(){function e(e){if(!r.allowed)throw new Error("Async can only be called from within state.enter()");var t=n.defer();return a.push(t),n(e).then(function(e){a.indexOf(t)>-1&&t.resolve(e)},function(e){a.indexOf(t)>-1&&t.reject(e)}),t.promise}function t(){a.length=0}var r,a=[];return r={register:e,newTransitionStarted:t,allowed:!1}}();b.Async=_.register,b.State=E;var A=i,O=i;S.enableLogs=function(){function e(e){for(var t=e[0],n=Array.prototype.slice.call(e,1),r=0,a=n.length;a>r;r++)t=t.replace("{"+r+"}",n[r]);return t}A=function(){"undefined"!=typeof console&&console.log(e(arguments))},O=function(){"undefined"!=typeof console&&console.error(e(arguments))}},b.Router=S;var N=function(e){function t(e){var t=e.which,n=e.button;return t||"undefined"==typeof n||(t=1&n?1:2&n?3:4&n?2:1),1===t}function n(e){for(;e;){if("A"===e.nodeName)return e;e=e.parentNode}}function r(t){var n=e.document.createElement("A");return n.href=t.href,n.protocol===a.protocol&&n.hostname===a.hostname&&(n.port||"80")===(a.port||"80")}if(e&&e.document){var a=d();return function(a,i){function o(i){var o=i||e.event,u=o.target||o.srcElement,c="defaultPrevented"in o?o.defaultPrevented:o.returnValue===!1;if(!(c||o.metaKey||o.ctrlKey||o.shiftKey||o.altKey)&&t(o)){var f=n(u);f&&f.getAttribute("href",2)&&!f.getAttribute("target")&&r(f)&&!/([a-z0-9_\-]+\:)?\/\/[^@]+@/.test(f.href)&&(o.preventDefault?o.preventDefault():o.returnValue=!1,a.state(p(f)))}}return i||(i=e.document),i.addEventListener?i.addEventListener("click",o):i.attachEvent&&i.attachEvent("onclick",o),function(){i.removeEventListener?i.removeEventListener("click",o):i.detachEvent&&i.detachEvent("onclick",o)}}}}(this);return b.interceptAnchorClicks=N,b};"function"==typeof define&&define.amd?define(["abyssa"],e):"undefined"!=typeof module&&module.exports?module.exports=e(require("signals"),require("crossroads"),require("when"),require("history")):window.Abyssa=e(window.signals,window.crossroads,window.when,window.history)}();