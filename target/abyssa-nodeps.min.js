/* abyssa 1.2.4 - A stateful router library for single page applications */

!function(a){"function"==typeof define&&define.amd?define([],a):"object"==typeof exports?module.exports=a():window.Abyssa=a()}(function(){function a(a){return"[object String]"==Object.prototype.toString.call(a)}function b(){}function c(a){return a.reduce(function(a,b){return a[b]=1,a},{})}function d(a){var b=[];for(var c in a)b.push(a[c]);return b}function e(a){var b={};for(var c in a)b[c]=a[c];return b}function f(a,b){for(var c in b)a[c]=b[c]}function g(a){var b=0;for(var c in a)b++;return b}function h(a,b,c){function d(a,b){return l.then(function(){g||a()},function(a){g||b(a)})}function e(){g=s.cancelled=!0}var f,g,h,l,n=[],o=a&&a._state,p=b._state,q=b.params,r=o==p,s={from:o,to:p,toParams:q,then:d,cancel:e,cancelled:g,currentState:o};return o&&(f=k(o,p,r,c),n=m(o,f,r)),h=m(p,f,r).reverse(),l=i(h,n,q).then(function(){g||j(h,n,q,s)}),t.newTransitionStarted(),s}function i(a,b,c){return b.forEach(function(a){if(a.exitPrereqs)var b=a._exitPrereqs=when(a.exitPrereqs()).then(function(c){a._exitPrereqs==b&&(a._exitPrereqs.value=c)},function(){throw new Error("Failed to resolve EXIT prereqs of "+a.fullName)})}),a.forEach(function(a){if(a.enterPrereqs)var b=a._enterPrereqs=when(a.enterPrereqs(c)).then(function(c){a._enterPrereqs==b&&(a._enterPrereqs.value=c)},function(){throw new Error("Failed to resolve ENTER prereqs of "+a.fullName)})}),when.all(a.concat(b).map(function(a){return a._enterPrereqs||a._exitPrereqs}))}function j(a,b,c,d){b.forEach(function(a){a.exit(a._exitPrereqs&&a._exitPrereqs.value)}),t.allowed=!0,a.forEach(function(a){d.cancelled||(d.currentState=a,a.enter(c,a._enterPrereqs&&a._enterPrereqs.value))}),t.allowed=!1}function k(a,b,c,d){var e,f,g;if(c)a.parents.slice().reverse().forEach(function(a){for(g in d)if(a.params[g]||a.queryParams[g]){e=a;break}});else for(var h=0;h<a.parents.length;h++)if(f=a.parents[h],b.parents.indexOf(f)>-1){e=f;break}return e}function l(a,b,c){var d=a.parents,e=Math.min(d.length,d.indexOf(b)+(c?1:0));return[a].concat(d.slice(0,e))}function m(a,b,c){var d=!b||c;return l(a,b||a.root,d)}function n(){function a(a,b){n.name=a,n.parent=b,n.parents=d(),n.children=e(),n.fullName=g(),n.root=n.parents[n.parents.length-1],n.async=q.Async,j(function(a,b){b.init(a,n)}),m=!0}function c(){for(var a=n.path,b=n.parent;b;)b.path&&(a=b.path+"/"+a),b=b.parent;return a}function d(){for(var a=[],b=n.parent;b;)a.push(b),b=b.parent;return a}function e(){var a=[];for(var b in s)a.push(s[b]);return a}function f(a){var b={};for(var c in a)a[c]._isState&&(b[c]=a[c]);return b}function g(){return n.parents.reduceRight(function(a,b){return a+b.name+"."},"")+n.name}function h(a){var b={enter:1,exit:1,enterPrereqs:1,exitPrereqs:1},c={};for(var d in a)b[d]||a[d]._isState||(c[d]=a[d]);return c}function i(a,b){if(void 0!==b){if(void 0!==n.ownData[a])throw new Error("State "+n.fullName+" already has data with the key "+a);return n.ownData[a]=b,n}for(var c=n;void 0===c.ownData[a]&&c.parent;)c=c.parent;return c.ownData[a]}function j(a){for(var b in s)a(b,s[b])}function k(a,b){if(m)throw new Error("States can only be added before the Router is initialized");if(s[a])throw new Error("The state {0} already has a child state named {1}".replace("{0}",n.name).replace("{1}",a));return s[a]=b,n}function l(){return n.fullName}var m,n={_isState:!0},p=o(arguments),r=p.options,s=f(p.options);return n.path=p.path,n.params=p.params,n.queryParams=p.queryParams,n.states=s,n.enter=r.enter||b,n.exit=r.exit||b,n.enterPrereqs=r.enterPrereqs,n.exitPrereqs=r.exitPrereqs,n.ownData=h(r),n.init=a,n.fullPath=c,n.data=i,n.addState=k,n.toString=l,n}function o(b){var d,e,f={path:"",options:{},params:{},queryParams:{}},g=b[0],h=b[1];return 1==b.length?a(g)?f.path=g:f.options=g:2==b.length&&(f.path=g,f.options="object"==typeof h?h:{enter:h}),d=f.path.indexOf("?"),-1!=d&&(f.queryParams=f.path.slice(d+1),f.path=f.path.slice(0,d),f.queryParams=c(f.queryParams.split("&"))),f.path=f.path.replace(/:\w*/g,function(a){return e=a.substring(1),f.params[e]=1,"{"+e+"}"}),f}function p(b){function c(a,b){if(!l(a,b)){var c,d=s(a,b);K?(i(),c=s(K.currentState,K.toParams)):c=J,J=d,j(c,d),K=h(c,d,m(c&&c.params,b)),K.then(function(){var a;K=null,N||S||(a=("/"+I).replace("//","/"),u("Pushing state: {0}",a),history.pushState(a,document.title,a)),k(c,d)},function(a){K=null,J=c,logError("Transition from {0} to {1} failed: {2}",c,d,a),P.transition.failed.dispatch(c,d)})}}function i(){u("Cancelling existing transition from {0} to {1}",K.from,K.to),K.cancel(),P.transition.cancelled.dispatch(K.from,K.to)}function j(a,b){u("Starting transition from {0} to {1}",a,b),P.transition.started.dispatch(a,b)}function k(a,b){u("Transition from {0} to {1} completed",a,b),P.transition.completed.dispatch(a,b),S=!1}function l(a,b){var c,d,e;return K?(c=K.to,d=K.toParams):J&&(c=J._state,d=J.params),e=m(d,b),a==c&&0==g(e)}function m(a,b){var c={},a=a||{};for(var d in a)a[d]!=b[d]&&(c[d]=1);for(var d in b)a[d]!=b[d]&&(c[d]=1);return c}function n(a){if(u("State not found: {0}",a),!Q.notFound)throw new Error('State "'+a+'" could not be found');c(Q.notFound)}function o(a){return f(T,a),P}function q(a){T.enableLogs&&p.enableLogs(),T.interceptAnchorClicks&&v(P),u("Router init"),t();var b=!p.ignoreInitialURL&&D()||a||"";return u("Initializing to state {0}",b||'""'),y(b),window.onpopstate=function(a){var b=a.state||D();u("Popped state: {0}",b),N=!0,A(b)},O=!0,P}function t(){w(function(a,b){b.init(a)}),L={},x(function(a){L[a.fullName]=a,a.route=R.addRoute(a.fullPath()+":?query:"),a.route.matched.add(function(){M=!0,c(a,E(a,arguments))})})}function w(a){for(var b in Q)a(b,Q[b])}function x(a){function b(c){c.forEach(function(c){c.children.length?b(c.children):a(c)})}b(d(Q))}function y(a,b){var c=a.indexOf(".")>-1||L[a];u("Changing state to {0}",a||'""'),N=!1,c?B(a,b||{}):A(a)}function z(a,b){u("Redirecting..."),y(a,b)}function A(a){I=a,M=!1,R.parse(a),M||n(a)}function B(a,b){var c=L[a];if(!c)return n(a);var d=c.route.interpolate(b);A(d)}function C(a,b){if(O)throw new Error("States can only be added before the Router is initialized");if(Q[a])throw new Error("A state already exist in the router with the name "+a);return u("Adding state {0}",a),Q[a]=b,P}function D(){var a=location.href.indexOf("#/");return a>-1?location.href.slice(a+2):(location.pathname+location.search).slice(1)}function E(b,c){var d,e=Array.prototype.slice.apply(c),g=e.pop(),h={};b.fullPath().replace(/\{\w*\}/g,function(a){return d=a.slice(1,-1),h[d]=e.shift(),""}),g&&f(h,g);for(var i in h)a(h[i])&&(h[i]=decodeURIComponent(h[i]));return h}function F(a,b){var c={},d={},e=!1,g=L[a];if(!g)throw new Error("Cannot find state "+a);[g].concat(g.parents).forEach(function(a){f(d,a.queryParams)});for(var h in b)d[h]&&(c[h]=b[h],delete b[h],e=!0);return e&&(b.query=c),"/"+g.route.interpolate(b).replace("/?","?")}function G(){return J}function H(a,b){P.transition.ended.dispatch(a,b)}var I,J,K,L,M,N,O,P={},Q=e(b),R=crossroads.create(),S=!0,T={enableLogs:!1,interceptAnchorClicks:!0};return R.shouldTypecast=!0,R.ignoreState=!0,P.configure=o,P.init=q,P.state=y,P.redirect=z,P.addState=C,P.link=F,P.currentState=G,P.transition={started:new r,ended:new r,completed:new r,failed:new r,cancelled:new r},P.initialized=new r,P.transition.completed.addOnce(function(){P.initialized.dispatch()}),P.transition.completed.add(H),P.transition.failed.add(H),P.transition.cancelled.add(H),P}var q={},r=signals.Signal,s=function(){function a(a,e){return{_state:a,name:a&&a.name,fullName:a&&a.fullName,data:a&&a.data,params:e,is:b,isIn:c,toString:d}}function b(a){return this.fullName==a}function c(a){for(var b=this._state;b;){if(b.fullName==a)return!0;b=b.parent}return!1}function d(){return this.fullName+":"+JSON.stringify(this.params)}return a}(),t=function(){function a(a){if(!c.allowed)throw new Error("Async can only be called from within state.enter()");var b=when.defer();return d.push(b),when(a).then(function(a){d.indexOf(b)>-1&&b.resolve(a)},function(a){d.indexOf(b)>-1&&b.reject(a)}),b.promise}function b(){d.length=0}var c,d=[];return c={register:a,newTransitionStarted:b,allowed:!1}}();q.Async=t.register,q.State=n;var u=logError=b;p.enableLogs=function(){function a(a){for(var b=a[0],c=Array.prototype.slice.call(a,1),d=0,e=c.length;e>d;d++)b=b.replace("{"+d+"}",c[d]);return b}u=function(){console.log(a(arguments))},logError=function(){console.error(a(arguments))}},q.Router=p;var v=function(){function a(a){a=a||window.event;var d="defaultPrevented"in a?a.defaultPrevented:a.returnValue===!1;if(!(d||a.metaKey||a.ctrlKey)&&b(a)){var f=a.target||a.srcElement,g=c(f);if(g){var h=g.getAttribute("href");"#"!=h.charAt(0)&&"_blank"!=g.getAttribute("target")&&e(g)&&(a.preventDefault?a.preventDefault():a.returnValue=!1,router.state(h))}}}function b(a){a=a||window.event;var b=void 0!==a.which?a.which:f;return 1==b}function c(a){for(;a;){if("A"==a.nodeName)return a;a=a.parentNode}}function d(a){f=(a||window.event).button}function e(a){var b=a.hostname,c=a.port;if(!b){var d=document.createElement("a");d.href=a.href,b=d.hostname,c=d.port}var e=b==location.hostname,f=(c||"80")==(location.port||"80");return e&&f}var f;return function(){document.addEventListener?document.addEventListener("click",a):(document.attachEvent("onmousedown",d),document.attachEvent("onclick",a))}}();return q});