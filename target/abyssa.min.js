/* abyssa 6.7.0 - A stateful router library for single page applications */

!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.Abyssa=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(){},{}],2:[function(a,b){"use strict";function c(a){function b(a,b,c){var d=j.objectDiff(_&&_.params,b);if(!c&&t(a,d))return m(_);var e,f=h(a,b);bb?(n(),e=h(bb.currentState,bb.toParams)):e=_,ab=_,_=f,mb=d;var g=bb,s=bb=i(e,f,d,c,k);return o(e,f),bb!=s?l(bb):(bb.then(function(){r(c),p(e,f)},function(a){_=h(bb.currentState,bb.toParams),r(c),q(e,f,a)}),l(g||bb))}function l(a){function b(a){gb.transition.failed.remove(c),d.resolve(a)}function c(a,c,e){gb.transition.completed.remove(b),d.reject(e)}if(a.promise)return a.promise;var d=f.defer();return gb.transition.completed.addOnce(b),gb.transition.failed.addOnce(c),a.promise=d.promise,a.promise}function m(a){return gb.transition.prevented.dispatch(a),f.reject(new Error("prevented"))}function n(){k.log("Cancelling existing transition from {0} to {1}",bb.from,bb.to),bb.cancel(),jb=!1,gb.transition.cancelled.dispatch(bb.to,bb.from)}function o(a,b){k.log("Starting transition from {0} to {1}",a,b),gb.transition.started.dispatch(b,a)}function p(a,b){k.log("Transition from {0} to {1} completed",a,b),b.state.lastParams=b.params,gb.transition.completed.dispatch(b,a)}function q(a,b,c){function d(){e=!0}k.error("Transition from {0} to {1} failed: {2}",a,b,c);var e;gb.transition.failed.dispatch(b,a,c,d),e||setTimeout(function(){throw c},0)}function r(a){db||jb||a||(k.log("Updating URL: {0}",$),s($,document.title,$)),bb=null,jb=!1,gb.flash=null}function s(a,b,c){kb.urlSync&&(L()?(lb=!0,location.hash=kb.hashPrefix+c):history.pushState(a,b,c))}function t(a,b){return _?a==_.state&&0==j.objectSize(b.all):!1}function u(a){if(k.log("State not found: {0}",a),kb.notFound)return b(cb[kb.notFound]||kb.notFound,{});throw new Error('State "'+a+'" could not be found')}function v(a){return j.mergeObjects(kb,a),gb}function w(a,b){return kb.enableLogs&&c.enableLogs(),kb.interceptAnchors&&g(gb),fb="#"+kb.hashPrefix+"/",k.log("Router init"),A(),Y(),a=void 0!==a?a:z(),k.log("Initializing to state {0}",a||'""'),D(a,b),y(),eb=!0,gb}function x(){window.onhashchange=null,window.onpopstate=null}function y(){function a(a){if(lb)return void(lb=!1);var b=L()?K():a.state;k.log("URL changed: {0}",b),db=!0,H(b)}kb.urlSync&&(window[L()?"onhashchange":"onpopstate"]=a)}function z(){return kb.urlSync?K():""}function A(){B(function(a,b){b.init(gb,a)}),kb.notFound&&kb.notFound.init&&kb.notFound.init("notFound"),cb={},C(hb)}function B(a){for(var b in hb)a(b,hb[b])}function C(a){function b(a){a.forEach(function(a){a.children.length?b(a.children):c(a)})}function c(a){cb[a.fullName]=a;var b=ib.addRoute(a.fullPath()+":?query:");a.route=b,b.abyssaState=a}b(j.objectToArray(a))}function D(a){var b=void 0!==cb[a],c=b?arguments[1]:null,d=b?arguments[2]:arguments[1];if(k.log("Changing state to {0}",a||'""'),j.isPlainObject(gb.flash)&&j.isPlainObject(d)){var e={};j.mergeObjects(e,gb.flash),j.mergeObjects(e,d),d=e}return gb.flash=d,db=!1,b?I(a,c||{}):H(a)}function E(){return k.log("Redirecting..."),D.apply(null,arguments)}function F(a,b,c){var d=cb[a].lastParams||b;return D(a,d,c)}function G(){return b(_.state,_.params,!0)}function H(a){function c(a,b){e=b}var d,e;return $=j.normalizePathQuery(a),ib.routed.add(c),ib.parse($),ib.routed.remove(c),e&&(d=b(e.route.abyssaState,M(e.route.abyssaState,e.params))),d||u($)}function I(a,b){var c=cb[a];if(!c)return u(a);var d=P(c,b);return H(d)}function J(a,b){if(hb[a])throw new Error("A state already exist in the router with the name "+a);return hb[a]=b,eb&&(b.init(gb,a),C({name:b})),gb}function K(){var a,b=location.href.indexOf(fb);return a=b>-1?location.href.slice(b+fb.length):L()?"/":(location.pathname+location.search).slice(1),j.normalizePathQuery(a)}function L(){return"hash"==kb.urlSync}function M(a,b){var c,d=Array.prototype.slice.apply(b),e=d.pop(),f={};a.fullPath().replace(nb,function(a){return c=a.slice(1,-1),f[c]=d.shift(),""}),a.fullPath().replace(ob,function(a){c=a.slice(1,-2),f[c]=d.shift()}),e&&j.mergeObjects(f,e);for(var g in f)j.isString(f[g])&&(f[g]=decodeURIComponent(f[g]));return f}function N(a,b){var c={},d=a.allQueryParams();for(var e in b)d[e]?(c.query=c.query||{},c.query[e]=b[e]):c[e]=b[e];return c}function O(a,b){var c=cb[a];if(!c)throw new Error("Cannot find state "+a);var d=P(c,b);return j.normalizePathQuery(d)}function P(a,b){var c={};for(var d in b)c[d]=encodeURIComponent(b[d]);var e=N(a,c),f=a.route.interpolate(e),g=f.split("?"),h=g[0],i=g[1];return f=h+(i?"?"+decodeURI(i):"")}function Q(){return _}function R(){return ab}function S(){return $.split("?")[0]}function T(){return $.split("?")[1]}function U(){return j.copyObject(_.params)}function V(){var a=_.state.allQueryParams(),b=_.params,c={};for(var d in b)d in a&&(c[d]=b[d]);return c}function W(){return mb}function X(){return null==ab}function Y(){if(k.enabled){var a=function(a){return 0==a?"":new Array(2+4*(a-1)).join(" ")+"── "},b=function(c){var d=j.normalizePathQuery(c.fullPath()),e=0==c.children.length?" (@ path)".replace("path",d):"",f=a(c.parents.length)+c.name+e+"\n";return f+c.children.map(b).join("")},c="\nState tree\n\n";c+=j.objectToArray(hb).map(b).join(""),c+="\n",k.log(c)}}function Z(a){return function(b,c){gb.transition.ended.dispatch(b,c,a)}}var $,_,ab,bb,cb,db,eb,fb,gb={},hb=j.copyObject(a),ib=e.create(),jb=!0,kb={enableLogs:!1,interceptAnchors:!0,notFound:null,urlSync:!0,hashPrefix:""},lb=!1,mb={};ib.shouldTypecast=!0,ib.ignoreState=!0;var nb=/\{\w*\}/g,ob=/:\w*\*:/;return gb.configure=v,gb.init=w,gb.state=D,gb.redirect=E,gb.backTo=F,gb.reload=G,gb.addState=J,gb.link=O,gb.currentState=Q,gb.previousState=R,gb.isFirstTransition=X,gb.path=S,gb.query=T,gb.params=U,gb.queryParams=V,gb.paramsDiff=W,gb.urlPathQuery=K,gb.terminate=x,gb.transition={started:new d,ended:new d,completed:new d,failed:new d,cancelled:new d,prevented:new d},gb.changed=gb.transition.completed,gb.transition.completed.add(Z("completed")),gb.transition.failed.add(Z("failed")),gb.transition.cancelled.add(Z("cancelled")),gb}var d=a("signals").Signal,e=a("crossroads"),f=a("q"),g=a("./anchors"),h=a("./StateWithParams"),i=a("./Transition"),j=a("./util"),k={log:j.noop,error:j.noop,enabled:!1};c.enableLogs=function(){k.enabled=!0,k.log=function(){var a=j.makeMessage.apply(null,arguments);console.log(a)},k.error=function(){var a=j.makeMessage.apply(null,arguments);console.error(a)}},b.exports=c},{"./StateWithParams":4,"./Transition":5,"./anchors":6,"./util":8,crossroads:1,q:1,signals:1}],3:[function(a,b){"use strict";function c(){function a(a,b,d){p.router=a,p.name=b,p.parent=d,p.parents=c(),p.root=p.parent?p.parents[p.parents.length-1]:p,p.children=g(),p.fullName=i(),p.root=p.parents[p.parents.length-1],p.async=f,l(function(b,c){c.init(a,b,p)}),o=!0}function b(){for(var a=p.path,b=p.parent;b;)b.path&&(a=b.path+"/"+a),b=b.parent;return a}function c(){for(var a=[],b=p.parent;b;)a.push(b),b=b.parent;return a}function g(){var a=[];for(var b in s)a.push(s[b]);return a}function h(a){var b={};for(var c in a)a[c]._isState&&(b[c]=a[c]);return b}function i(){return p.parents.reduceRight(function(a,b){return a+b.name+"."},"")+p.name}function j(){return p.parents.reduce(function(a,b){return e.mergeObjects(a,b.queryParams)},e.copyObject(p.queryParams))}function k(a,b){if(void 0!==b)return p.ownData[a]=b,p;for(var c=p;void 0===c.ownData[a]&&c.parent;)c=c.parent;return c.ownData[a]}function l(a){for(var b in s)a(b,s[b])}function m(a,b){if(o)throw new Error("States can only be added before the Router is initialized");if(s[a])throw new Error("The state {0} already has a child state named {1}".replace("{0}",p.name).replace("{1}",a));return s[a]=b,p}function n(){return p.fullName}var o,p={_isState:!0},q=d(arguments),r=q.options,s=h(q.options);return p.path=q.path,p.params=q.params,p.queryParams=q.queryParams,p.states=s,p.enter=r.enter||e.noop,p.update=r.update,p.exit=r.exit||e.noop,p.ownData=r.data||{},p.init=a,p.fullPath=b,p.allQueryParams=j,p.data=k,p.addState=m,p.toString=n,p}function d(a){var b,c,d={path:"",options:{},params:{},queryParams:{}},f=a[0],g=a[1];return 1==a.length?e.isString(f)?d.path=f:d.options=f:2==a.length&&(d.path=f,d.options="object"==typeof g?g:{enter:g}),b=d.path.indexOf("?"),-1!=b&&(d.queryParams=d.path.slice(b+1),d.path=d.path.slice(0,b),d.queryParams=e.arrayToObject(d.queryParams.split("&"))),d.path=d.path.replace(/:[^\\?\/]*/g,function(a){var b;return c=a.substring(1),"*"==c[c.length-1]&&(c=c.slice(0,-1),b=!0),d.params[c]=1,b?":"+c+"*:":"{"+c+"}"}),d}var e=a("./util"),f=a("./Transition").asyncPromises.register;b.exports=c},{"./Transition":5,"./util":8}],4:[function(a,b){"use strict";function c(a,b){return{state:a,params:b,isIn:d,toString:e}}function d(a){for(var b=this.state;b;){if(b.fullName==a)return!0;b=b.parent}return!1}function e(){return this.state.fullName+":"+JSON.stringify(this.params)}b.exports=c},{}],5:[function(a,b){"use strict";function c(a,b,c,g,j){function l(a,b){return q.then(function(){o||a()},function(a){o||b(a)})}function m(){o=x.cancelled=!0}var n,o,p,q,r=[],s=a&&a.state,t=b.state,u=b.params,v=s==t,w=v&&!g,x={from:s,to:t,toParams:u,then:l,cancel:m,cancelled:o,currentState:s};return s&&(n=g?t.root:f(s,t,v,c),r=h(s,n,v)),p=h(t,n,v).reverse(),k.newTransitionStarted(),q=d(v,g,c)?i("null"):e(p,r,u,x,w,j),x}function d(a,b,c){return a&&!b&&0==j.objectSize(c.all)}function e(a,b,c,d,e,f){function g(a,b){return function(e){if(h(),f.enabled){var g=b[0].toUpperCase()+b.slice(1);f.log(g+" "+a.fullName)}var i=a[b](c,e);return h(),void 0===i&&(i=e),d.currentState="exit"==b?a.parent:a,i}}function h(){if(d.cancelled)throw new Error("transition cancelled")}var j=i();return b.forEach(function(a){e&&a.update||(j=j.then(g(a,"exit")))}),a.forEach(function(a){var b=e&&a.update?"update":"enter";j=j.then(g(a,b))}),j}function f(a,b,c,d){var e,f,g;if(c)[a].concat(a.parents).reverse().forEach(function(a){if(!e)for(g in d.all)if(a.params[g]||a.queryParams[g]){e=a;break}});else for(var h=0;h<a.parents.length;h++)if(f=a.parents[h],b.parents.indexOf(f)>-1){e=f;break}return e}function g(a,b,c){var d=a.parents,e=Math.min(d.length,d.indexOf(b)+(c?1:0));return[a].concat(d.slice(0,e))}function h(a,b,c){var d=!b||c;return g(a,b||a.root,d)}var i=a("q"),j=a("./util"),k=c.asyncPromises=function(){function a(a){var b=i.defer();return d.push(b),i(a).then(function(a){d.indexOf(b)>-1&&b.resolve(a)},function(a){d.indexOf(b)>-1&&b.reject(a)}),b.promise}function b(){d.length=0}var c,d=[];return c={register:a,newTransitionStarted:b}}();b.exports=c},{"./util":8,q:1}],6:[function(a,b){"use strict";function c(a){var b=e(a);void 0!==b&&i.state(b)}function d(a){var b=e(a);void 0!==b&&(a.preventDefault(),i.state(b))}function e(a){if(!(a.defaultPrevented||a.metaKey||a.ctrlKey)&&f(a)){var b=a.target,c=g(b);if(c){var d=c.getAttribute("data-nav");if("ignore"!=d&&("mousedown"!=a.type||"mousedown"==d)){var e=c.getAttribute("href");if(e&&"#"!=e.charAt(0)&&"_blank"!=c.getAttribute("target")&&h(c))return"click"==a.type&&"mousedown"==d?void a.preventDefault():e}}}}function f(a){return 1==a.which}function g(a){for(;a;){if("A"==a.nodeName)return a;a=a.parentNode}}function h(a){var b=a.hostname,c=a.port;if(!b){var d=document.createElement("a");d.href=a.href,b=d.hostname,c=d.port}var e=b==location.hostname,f=(c||"80")==(location.port||"80");return e&&f}var i;b.exports=function(a){i=a,document.addEventListener("mousedown",c),document.addEventListener("click",d)}},{}],7:[function(a,b){"use strict";var c={Router:a("./Router"),State:a("./State"),Async:a("./Transition").asyncPromises.register,util:a("./util")};b.exports=c},{"./Router":2,"./State":3,"./Transition":5,"./util":8}],8:[function(a,b){"use strict";function c(a){return"[object String]"==Object.prototype.toString.call(a)}function d(){}function e(a){return a.reduce(function(a,b){return a[b]=1,a},{})}function f(a){var b=[];for(var c in a)b.push(a[c]);return b}function g(a){var b={};for(var c in a)b[c]=a[c];return b}function h(a,b){for(var c in b)a[c]=b[c];return a}function i(a){return a&&a.constructor===Object}function j(a){var b=0;for(var c in a)b++;return b}function k(a,b){var c,d,e={},f={},g={},h={},a=a||{};for(d in a)d in b?a[d]!=b[d]&&(e[d]=h[d]=!0):g[d]=h[d]=!0;for(d in b)d in a||(f[d]=h[d]=!0);return c={all:h,update:e,enter:f,exit:g}}function l(){for(var a=arguments[0],b=Array.prototype.slice.call(arguments,1),c=0,d=b.length;d>c;c++)a=a.replace("{"+c+"}",b[c]);return a}function m(a){return"/"+a.replace(n,"").replace(o,"$1").replace(p,"?")}var n=/^\/+/,o=/^([^?]*?)\/+$/,p=/\/+\?/;b.exports={isString:c,noop:d,arrayToObject:e,objectToArray:f,copyObject:g,mergeObjects:h,isPlainObject:i,objectSize:j,makeMessage:l,normalizePathQuery:m,objectDiff:k}},{}]},{},[7])(7)});