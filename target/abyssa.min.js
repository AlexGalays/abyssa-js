/* abyssa 7.0.0 - A stateful router library for single page applications */

!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.Abyssa=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function d(a){return"function"==typeof a}function e(a){return"number"==typeof a}function f(a){return"object"==typeof a&&null!==a}function g(a){return void 0===a}b.exports=c,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._maxListeners=void 0,c.defaultMaxListeners=10,c.prototype.setMaxListeners=function(a){if(!e(a)||0>a||isNaN(a))throw TypeError("n must be a positive number");return this._maxListeners=a,this},c.prototype.emit=function(a){var b,c,e,h,i,j;if(this._events||(this._events={}),"error"===a&&(!this._events.error||f(this._events.error)&&!this._events.error.length))throw b=arguments[1],b instanceof Error?b:TypeError('Uncaught, unspecified "error" event.');if(c=this._events[a],g(c))return!1;if(d(c))switch(arguments.length){case 1:c.call(this);break;case 2:c.call(this,arguments[1]);break;case 3:c.call(this,arguments[1],arguments[2]);break;default:for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];c.apply(this,h)}else if(f(c)){for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];for(j=c.slice(),e=j.length,i=0;e>i;i++)j[i].apply(this,h)}return!0},c.prototype.addListener=function(a,b){var e;if(!d(b))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",a,d(b.listener)?b.listener:b),this._events[a]?f(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b,f(this._events[a])&&!this._events[a].warned){var e;e=g(this._maxListeners)?c.defaultMaxListeners:this._maxListeners,e&&e>0&&this._events[a].length>e&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),"function"==typeof console.trace&&console.trace())}return this},c.prototype.on=c.prototype.addListener,c.prototype.once=function(a,b){function c(){this.removeListener(a,c),e||(e=!0,b.apply(this,arguments))}if(!d(b))throw TypeError("listener must be a function");var e=!1;return c.listener=b,this.on(a,c),this},c.prototype.removeListener=function(a,b){var c,e,g,h;if(!d(b))throw TypeError("listener must be a function");if(!this._events||!this._events[a])return this;if(c=this._events[a],g=c.length,e=-1,c===b||d(c.listener)&&c.listener===b)delete this._events[a],this._events.removeListener&&this.emit("removeListener",a,b);else if(f(c)){for(h=g;h-->0;)if(c[h]===b||c[h].listener&&c[h].listener===b){e=h;break}if(0>e)return this;1===c.length?(c.length=0,delete this._events[a]):c.splice(e,1),this._events.removeListener&&this.emit("removeListener",a,b)}return this},c.prototype.removeAllListeners=function(a){var b,c;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[a]&&delete this._events[a],this;if(0===arguments.length){for(b in this._events)"removeListener"!==b&&this.removeAllListeners(b);return this.removeAllListeners("removeListener"),this._events={},this}if(c=this._events[a],d(c))this.removeListener(a,c);else for(;c.length;)this.removeListener(a,c[c.length-1]);return delete this._events[a],this},c.prototype.listeners=function(a){var b;return b=this._events&&this._events[a]?d(this._events[a])?[this._events[a]]:this._events[a].slice():[]},c.listenerCount=function(a,b){var c;return c=a._events&&a._events[b]?d(a._events[b])?1:a._events[b].length:0}},{}],2:[function(a,b){"use strict";function c(a){function b(a,b,c){var d=R?f(R.currentState,R.toParams):P,e=f(a,b),i=h.objectDiff(d&&d.params,b);return p(d,e,i)?void(R&&R.exiting&&l()):(R&&l(),Q=P,P=e,_=i,R=g(d,e,i,c,k),m(d,e),R&&R.run(),R&&(R.cancelled?P=d:n(d,e)),void(R=null))}function l(){k.log("Cancelling existing transition from {0} to {1}",R.from,R.to),R.cancel(),Y=!1}function m(a,b){k.log("Starting transition from {0} to {1}",a,b);var c=a?a.asPublic:null,d=b.asPublic;W.transition.emit("started",d,c)}function n(a,b){T||Y||(k.log("Updating URL: {0}",O),o(O,document.title,O)),Y=!1,k.log("Transition from {0} to {1} ended",a,b),b.state.lastParams=b.params;var c=a?a.asPublic:null,d=b.asPublic;W.transition.emit("ended",d,c)}function o(a,b,c){E()?($=!0,location.hash=Z.hashPrefix+c):history.pushState(a,b,c)}function p(a,b,c){return a?b.state==a.state&&0==h.objectSize(c.all):!1}function q(a){if(k.log("State not found: {0}",a),Z.notFound)return b(S[Z.notFound],{});throw new Error('State "'+a+'" could not be found')}function r(a){return h.mergeObjects(Z,a),W}function s(a,b){return Z.enableLogs&&c.enableLogs(),Z.interceptAnchors&&e(W),V="#"+Z.hashPrefix+"/",k.log("Router init"),v(),N(),a=void 0!==a?a:D(),k.log("Initializing to state {0}",a||'""'),y(a,b),u(),U=!0,W}function t(){window.onhashchange=null,window.onpopstate=null}function u(){function a(a){if($)return void($=!1);var b=a.state||D();k.log("URL changed: {0}",b),T=!0,A(b)}window[E()?"onhashchange":"onpopstate"]=a}function v(){w(function(a,b){b.init(W,a)}),S={},x(X)}function w(a){for(var b in X)a(b,X[b])}function x(a){function b(a){a.forEach(function(a){a.children.length?b(a.children):(S[a.fullName]=a,a.paths=h.parsePaths(a.fullPath()))})}b(h.objectToArray(a))}function y(a){var b=void 0!==S[a],c=(b?arguments[1]:null)||{},d=b?arguments[2]:arguments[1];k.log("Changing state to {0}",a||'""'),T=!1,b?B(a,c,d):A(a,d)}function z(a,b,c){var d=S[a].lastParams||b;y(a,d,c)}function A(a,c){var d,e,f,g;O=h.normalizePathQuery(a);var i=O.split("?"),j=i[0],k=i[1],l=h.parsePaths(j),m=h.parseQueryParams(k);for(var n in S)if(f=S[n],g=f.matches(l)){d=f,e=h.mergeObjects(g,m);break}d?b(d,e,c):q(O)}function B(a,b,c){var d=S[a];if(!d)return q(a);var e=G(d,b);A(e,c)}function C(a,b){if(X[a])throw new Error("A state already exist in the router with the name "+a);return b=M(b),X[a]=b,U&&(b.init(W,a),x({_:b})),W}function D(){var a,b=location.href.indexOf(V);return a=b>-1?location.href.slice(b+V.length):E()?"/":(location.pathname+location.search).slice(1),h.normalizePathQuery(a)}function E(){return"hash"==Z.urlSync}function F(a,b){var c=S[a];if(!c)throw new Error("Cannot find state "+a);var d=G(c,b);return h.normalizePathQuery(d)}function G(a,b){var c={};for(var d in b)c[d]=encodeURIComponent(b[d]);return a.interpolate(c)}function H(){return P?P.asPublic:null}function I(){return Q?Q.asPublic:null}function J(){return _}function K(){return null==Q}function L(a){return h.mapValues(a,M)}function M(a){return a.children&&(a.children=L(a.children)),i(a)}function N(){if(k.enabled){var a=function(a){return 0==a?"":new Array(2+4*(a-1)).join(" ")+"── "},b=function(c){var d=h.normalizePathQuery(c.fullPath()),e=0==c.children.length?" (@ path)".replace("path",d):"",f=a(c.parents.length)+c.name+e+"\n";return f+c.children.map(b).join("")},c="\nState tree\n\n";c+=h.objectToArray(X).map(b).join(""),c+="\n",k.log(c)}}var O,P,Q,R,S,T,U,V,W={},X=L(a),Y=!0,Z={enableLogs:!1,interceptAnchors:!0,notFound:null,urlSync:!0,hashPrefix:""},$=!1,_={};return W.configure=r,W.init=s,W.transitionTo=y,W.backTo=z,W.addState=C,W.link=F,W.current=H,W.previous=I,W.isFirstTransition=K,W.paramsDiff=J,W.transition=new d,W.urlPathQuery=D,W.terminate=t,h.mergeObjects(j,W),W}var d=a("events"),e=a("./anchors"),f=a("./StateWithParams"),g=a("./Transition"),h=a("./util"),i=a("./State"),j=a("./api"),k={log:h.noop,error:h.noop,enabled:!1};c.enableLogs=function(){k.enabled=!0,k.log=function(){var a=h.makeMessage.apply(null,arguments);console.log(a)},k.error=function(){var a=h.makeMessage.apply(null,arguments);console.error(a)}},b.exports=c},{"./State":3,"./StateWithParams":4,"./Transition":5,"./anchors":6,"./api":7,"./util":10,events:1}],3:[function(a,b){"use strict";function c(a){function b(a,b,c){s.router=a,s.name=b,s.parent=c,s.parents=j(),s.root=s.parent?s.parents[s.parents.length-1]:s,s.children=k(),s.fullName=l(),o(function(b,c){c.init(a,b,s)})}function c(){for(var a=s.path,b=s.parent;b;)b.path&&(a=b.path+"/"+a),b=b.parent;return a}function j(){for(var a=[],b=s.parent;b;)a.push(b),b=b.parent;return a}function k(){var a=[];for(var b in t)a.push(t[b]);return a}function l(){return s.parents.reduceRight(function(a,b){return a+b.name+"."},"")+s.name}function m(){return s.parents.reduce(function(a,b){return h.mergeObjects(a,b.queryParams)},h.copyObject(s.queryParams))}function n(a,b){if(void 0!==b)return s.ownData[a]=b,s;for(var c=s;void 0===c.ownData[a]&&c.parent;)c=c.parent;return c.ownData[a]}function o(a){for(var b in t)a(b,t[b])}function p(a){var b={},c=s.paths.filter(function(a){return"*"!=a[a.length-1]});if(c.length>a.length)return!1;for(var e=0;e<a.length;e++){var f=a[e],g=s.paths[e];if(!g)return!1;var h="*"==g[g.length-1];if(h){var i=d(g);return b[i]=a.slice(e).join("/"),b}var j=":"==g[0];if(j){var i=d(g);b[i]=f}else if(g!=f)return!1}return b}function q(a){var b=s.fullPath().replace(i,function(b){return a[d(b)]||""}),c=m(),e=Object.keys(a).filter(function(a){return c[a]}),f=e.map(function(b){return b+"="+a[b]}).join("&");return b+(f.length?"?"+f:"")}function r(){return s.fullName}var s={},t=a.children;return s.path=e(a.uri),s.params=f(a.uri),s.queryParams=g(a.uri),s.states=t,s.enter=a.enter||h.noop,s.update=a.update,s.exit=a.exit||h.noop,s.ownData=a.data||{},s.init=b,s.fullPath=c,s.allQueryParams=m,s.matches=p,s.interpolate=q,s.data=n,s.toString=r,s}function d(a){return"*"==a[a.length-1]?a.substr(1).slice(0,-1):a.substr(1)}function e(a){return(a||"").split("?")[0]}function f(a){var b=i.exec(a);return b?h.arrayToObject(b.map(d)):{}}function g(a){var b=(a||"").split("?")[1];return b?h.arrayToObject(b.split("&")):{}}var h=a("./util"),i=/:[^\\?\/]*/g;b.exports=c},{"./util":10}],4:[function(a,b){"use strict";function c(a,b,c){return{state:a,params:b,toString:e,asPublic:d(a,b,c)}}function d(a,b,c){function d(b){for(var c=a;c;){if(c.fullName==b)return!0;c=c.parent}return!1}return{uri:c,params:b,name:a?a.name:"",fullName:a?a.fullName:"",data:a?a.data:null,isIn:d}}function e(){var a=this.state&&this.state.fullName;return a+":"+JSON.stringify(this.params)}b.exports=c},{}],5:[function(a,b){"use strict";function c(a,b,c,e,g){function i(){d(l,m,p,r,q,e,g)}function j(){r.cancelled=!0}var k,l,m=[],n=a&&a.state,o=b.state,p=b.params,q=n==o,r={from:n,to:o,toParams:p,cancel:j,cancelled:!1,currentState:n,run:i};return n&&(k=f(n,o,q,c),m=h(n,k,q)),l=h(o,k,q).reverse(),r}function d(a,b,c,d,f,g,h){g=g||{},d.exiting=!0,b.forEach(function(a){f&&a.update||e(a,"exit",c,d,g,h)}),d.exiting=!1,a.forEach(function(a){var b=f&&a.update?"update":"enter";e(a,b,c,d,g,h)})}function e(a,b,c,d,e,f){if(!d.cancelled){if(f.enabled){var g=b[0].toUpperCase()+b.slice(1);f.log(g+" "+a.fullName)}var h=a[b](c,e);if(!d.cancelled)return d.currentState="exit"==b?a.parent:a,h}}function f(a,b,c,d){var e,f,g;if(c)[a].concat(a.parents).reverse().forEach(function(a){if(!e)for(g in d.all)if(a.params[g]||a.queryParams[g]){e=a;break}});else for(var h=0;h<a.parents.length;h++)if(f=a.parents[h],b.parents.indexOf(f)>-1){e=f;break}return e}function g(a,b,c){var d=a.parents,e=Math.min(d.length,d.indexOf(b)+(c?1:0));return[a].concat(d.slice(0,e))}function h(a,b,c){var d=!b||c;return g(a,b||a.root,d)}b.exports=c},{}],6:[function(a,b){"use strict";function c(a){var b=e(a);void 0!==b&&i.transitionTo(b)}function d(a){var b=e(a);void 0!==b&&(a.preventDefault(),i.transitionTo(b))}function e(a){if(!(a.defaultPrevented||a.metaKey||a.ctrlKey)&&f(a)){var b=a.target,c=g(b);if(c){var d=c.getAttribute("data-nav");if("ignore"!=d&&("mousedown"!=a.type||"mousedown"==d)){var e=c.getAttribute("href");if(e&&"#"!=e.charAt(0)&&"_blank"!=c.getAttribute("target")&&h(c))return"click"==a.type&&"mousedown"==d?void a.preventDefault():e}}}}function f(a){return 1==a.which}function g(a){for(;a;){if("A"==a.nodeName)return a;a=a.parentNode}}function h(a){var b=a.hostname,c=a.port;if(!b){var d=document.createElement("a");d.href=a.href,b=d.hostname,c=d.port}var e=b==location.hostname,f=(c||"80")==(location.port||"80");return e&&f}var i;b.exports=function(a){i=a,document.addEventListener("mousedown",c),document.addEventListener("click",d)}},{}],7:[function(a,b){b.exports={}},{}],8:[function(a,b){function c(a){var b=c.Promise||Promise,e=!0;d.transition.once("started",function(){e=!1});var f=new b(function(b,c){a.then(function(a){e&&b(a)},function(a){e&&c(a)})});return f}var d=a("./api");b.exports=c},{"./api":7}],9:[function(a,b){"use strict";var c=a("./util"),d={Router:a("./Router"),api:a("./api"),async:a("./async"),State:c.stateShorthand,_util:c};b.exports=d},{"./Router":2,"./api":7,"./async":8,"./util":10}],10:[function(a,b){"use strict";var c={};c.noop=function(){},c.arrayToObject=function(a){return a.reduce(function(a,b){return a[b]=1,a},{})},c.objectToArray=function(a){var b=[];for(var c in a)b.push(a[c]);return b},c.copyObject=function(a){var b={};for(var c in a)b[c]=a[c];return b},c.mergeObjects=function(a,b){for(var c in b)a[c]=b[c];return a},c.objectSize=function(a){var b=0;for(var c in a)b++;return b},c.mapValues=function(a,b){var c={};for(var d in a)c[d]=b(a[d]);return c},c.objectDiff=function(a,b){var c,d,e={},f={},g={},h={},a=a||{};for(d in a)d in b?a[d]!=b[d]&&(e[d]=h[d]=!0):g[d]=h[d]=!0;for(d in b)d in a||(f[d]=h[d]=!0);return c={all:h,update:e,enter:f,exit:g}},c.makeMessage=function(){for(var a=arguments[0],b=Array.prototype.slice.call(arguments,1),c=0,d=b.length;d>c;c++)a=a.replace("{"+c+"}",b[c]);return a},c.parsePaths=function(a){return a.split("/").filter(function(a){return a.length}).map(function(a){return decodeURIComponent(a)})},c.parseQueryParams=function(a){return a?a.split("&").reduce(function(a,b){var c=b.split("=");return a[c[0]]=decodeURIComponent(c[1]),a},{}):{}};var d=/^\/+/,e=/^([^?]*?)\/+$/,f=/\/+\?/;c.normalizePathQuery=function(a){return"/"+a.replace(d,"").replace(e,"$1").replace(f,"?")},c.stateShorthand=function(a,b,d){return c.mergeObjects({uri:a,children:d||{}},b)},b.exports=c},{}]},{},[9])(9)});