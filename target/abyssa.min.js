/* abyssa 6.1.1 - A stateful router library for single page applications */

!function(a){"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd?define(a):"undefined"!=typeof window?window.Abyssa=a():"undefined"!=typeof global?global.Abyssa=a():"undefined"!=typeof self&&(self.Abyssa=a())}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(){},{}],2:[function(a,b){"use strict";function c(a){function b(a,b,c){if(!c&&r(a,b))return k(U);var d,e=g(a,b,T);W?(l(),d=g(W.currentState,W.toParams)):d=U,V=U,U=e;var f=W=h(d,e,s(d&&d.params,b),c,j);m(d,e),W==f&&W.then(function(){p(c),n(d,e)},function(a){U=W.currentState,p(c),o(d,e,a)})}function k(a){_.transition.prevented.dispatch(a)}function l(){j.log("Cancelling existing transition from {0} to {1}",W.from,W.to),W.cancel(),cb=!1,_.flashData=null,_.transition.cancelled.dispatch(W.to,W.from)}function m(a,b){j.log("Starting transition from {0} to {1}",a,b),_.transition.started.dispatch(b,a)}function n(a,b){j.log("Transition from {0} to {1} completed",a,b),b.state.lastParams=b.params,_.transition.completed.dispatch(b,a)}function o(a,b,c){function d(){e=!0}j.error("Transition from {0} to {1} failed: {2}",a,b,c);var e;_.transition.failed.dispatch(b,a,c,d),e||setTimeout(function(){throw c},0)}function p(a){Z||cb||a||(j.log("Updating URL: {0}",T),q(T,document.title,T)),W=null,cb=!1,_.flashData=null}function q(a,b,c){db.urlSync&&((history.emulate||K())&&(eb=!0),K()?location.hash=c:history.pushState(a,b,c))}function r(a,b){if(!U)return!1;var c=s(U.params,b);return a==U.state&&0==i.objectSize(c)}function s(a,b){var c={},a=a||{};for(var d in a)a[d]!=b[d]&&(c[d]=1);for(var d in b)a[d]!=b[d]&&(c[d]=1);return c}function t(a){if(j.log("State not found: {0}",a),!db.notFound)throw new Error('State "'+a+'" could not be found');b(X[db.notFound]||db.notFound,{})}function u(a){return i.mergeObjects(db,a),_}function v(a,b){return db.enableLogs&&c.enableLogs(),db.interceptAnchors&&f(_),j.log("Router init"),z(),R(),a=void 0!==a?a:y(),j.log("Initializing to state {0}",a||'""'),C(a,b),x(),$=!0,_}function w(){window.onhashchange=null,window.onpopstate=null}function x(){function a(a){if(eb)return eb=!1,void 0;var b=K()?J():a.state||J();j.log("URL changed: {0}",b),Z=!0,G(b)}db.urlSync&&(window[K()?"onhashchange":"onpopstate"]=a)}function y(){return db.urlSync?J():""}function z(){A(function(a,b){b.init(_,a)}),db.notFound&&db.notFound.init&&db.notFound.init("notFound"),X={},B(function(a){X[a.fullName]=a,a.route=bb.addRoute(a.fullPath()+":?query:"),a.route.matched.add(function(){Y=!0,b(a,L(a,arguments))})})}function A(a){for(var b in ab)a(b,ab[b])}function B(a){function b(c){c.forEach(function(c){c.children.length?b(c.children):a(c)})}b(i.objectToArray(ab))}function C(a){var b=void 0!==X[a],c=b?arguments[1]:null,d=b?arguments[2]:arguments[1];j.log("Changing state to {0}",a||'""'),_.flashData=d,Z=!1,b?H(a,c||{}):G(a)}function D(){j.log("Redirecting..."),C.apply(null,arguments)}function E(a,b){var c=X[a].lastParams||b;C(a,c)}function F(){b(U.state,U.params,!0)}function G(a){T=i.normalizePathQuery(a),Y=!1,bb.parse(T),Y||t(T)}function H(a,b){var c=X[a];if(!c)return t(a);var d=c.route.interpolate(M(c,b));G(d)}function I(a,b){if($)throw new Error("States can only be added before the Router is initialized");if(ab[a])throw new Error("A state already exist in the router with the name "+a);return ab[a]=b,_}function J(){var a=location.href.indexOf("#/"),b=a>-1?location.href.slice(a+2):(location.pathname+location.search).slice(1);return i.normalizePathQuery(b)}function K(){return"hash"==db.urlSync}function L(a,b){var c,d=Array.prototype.slice.apply(b),e=d.pop(),f={};a.fullPath().replace(/\{\w*\}/g,function(a){return c=a.slice(1,-1),f[c]=d.shift(),""}),e&&i.mergeObjects(f,e);for(var g in f)i.isString(f[g])&&(f[g]=decodeURIComponent(f[g]));return f}function M(a,b){var c={},d={};[a].concat(a.parents).forEach(function(a){i.mergeObjects(d,a.queryParams)});for(var e in b)d[e]?(c.query=c.query||{},c.query[e]=b[e]):c[e]=b[e];return c}function N(a,b){var c=X[a];if(!c)throw new Error("Cannot find state "+a);var d=M(c,b);return i.normalizePathQuery(c.route.interpolate(d))}function O(){return U}function P(){return V}function Q(){return null==V}function R(){if(j.enabled){var a=function(a){return 0==a?"":new Array(2+4*(a-1)).join(" ")+"── "},b=function(c){var d=i.normalizePathQuery(c.fullPath()),e=0==c.children.length?" (@ path)".replace("path",d):"",f=a(c.parents.length)+c.name+e+"\n";return f+c.children.map(b).join("")},c="\nState tree\n\n";c+=i.objectToArray(ab).map(b).join(""),c+="\n",j.log(c)}}function S(a){return function(b,c){_.transition.ended.dispatch(b,c,a)}}var T,U,V,W,X,Y,Z,$,_={},ab=i.copyObject(a),bb=e.create(),cb=!0,db={enableLogs:!1,interceptAnchors:!0,notFound:null,urlSync:!0},eb=!1;return bb.shouldTypecast=!0,bb.ignoreState=!0,_.configure=u,_.init=v,_.state=C,_.redirect=D,_.backTo=E,_.reload=F,_.addState=I,_.link=N,_.currentState=O,_.previousState=P,_.isFirstTransition=Q,_.urlPathQuery=J,_.terminate=w,_.transition={started:new d,ended:new d,completed:new d,failed:new d,cancelled:new d,prevented:new d},_.changed=_.transition.completed,_.transition.completed.add(S("completed")),_.transition.failed.add(S("failed")),_.transition.cancelled.add(S("cancelled")),_}var d=a("signals").Signal,e=a("crossroads"),f=a("./anchors"),g=a("./StateWithParams"),h=a("./Transition"),i=a("./util"),j={log:i.noop,error:i.noop,enabled:!1};c.enableLogs=function(){j.enabled=!0,j.log=function(){var a=i.makeMessage.apply(null,arguments);console.log(a)},j.error=function(){var a=i.makeMessage.apply(null,arguments);console.error(a)}},b.exports=c},{"./StateWithParams":4,"./Transition":5,"./anchors":6,"./util":8,crossroads:1,signals:1}],3:[function(a,b){"use strict";function c(){function a(a,b,d){o.router=a,o.name=b,o.parent=d,o.parents=c(),o.root=o.parent?o.parents[o.parents.length-1]:o,o.children=g(),o.fullName=i(),o.root=o.parents[o.parents.length-1],o.async=f,k(function(b,c){c.init(a,b,o)}),n=!0}function b(){for(var a=o.path,b=o.parent;b;)b.path&&(a=b.path+"/"+a),b=b.parent;return a}function c(){for(var a=[],b=o.parent;b;)a.push(b),b=b.parent;return a}function g(){var a=[];for(var b in r)a.push(r[b]);return a}function h(a){var b={};for(var c in a)a[c]._isState&&(b[c]=a[c]);return b}function i(){return o.parents.reduceRight(function(a,b){return a+b.name+"."},"")+o.name}function j(a,b){if(void 0!==b)return o.ownData[a]=b,o;for(var c=o;void 0===c.ownData[a]&&c.parent;)c=c.parent;var d=o.router.flashData;return c.ownData[a]||d&&d[a]}function k(a){for(var b in r)a(b,r[b])}function l(a,b){if(n)throw new Error("States can only be added before the Router is initialized");if(r[a])throw new Error("The state {0} already has a child state named {1}".replace("{0}",o.name).replace("{1}",a));return r[a]=b,o}function m(){return o.fullName}var n,o={_isState:!0},p=d(arguments),q=p.options,r=h(p.options);return o.path=p.path,o.params=p.params,o.queryParams=p.queryParams,o.states=r,o.enter=q.enter||e.noop,o.update=q.update,o.exit=q.exit||e.noop,o.ownData=q.data||{},o.init=a,o.fullPath=b,o.data=j,o.addState=l,o.toString=m,o}function d(a){var b,c,d={path:"",options:{},params:{},queryParams:{}},f=a[0],g=a[1];return 1==a.length?e.isString(f)?d.path=f:d.options=f:2==a.length&&(d.path=f,d.options="object"==typeof g?g:{enter:g}),b=d.path.indexOf("?"),-1!=b&&(d.queryParams=d.path.slice(b+1),d.path=d.path.slice(0,b),d.queryParams=e.arrayToObject(d.queryParams.split("&"))),d.path=d.path.replace(/:\w*/g,function(a){return c=a.substring(1),d.params[c]=1,"{"+c+"}"}),d}var e=a("./util"),f=a("./Transition").asyncPromises.register;b.exports=c},{"./Transition":5,"./util":8}],4:[function(a,b){"use strict";function c(a,b,c){return{state:a,name:a&&a.name,fullName:a&&a.fullName,pathQuery:c,data:a&&a.data,params:b,isIn:d,toString:e}}function d(a){for(var b=this.state;b;){if(b.fullName==a)return!0;b=b.parent}return!1}function e(){return this.fullName+":"+JSON.stringify(this.params)}b.exports=c},{}],5:[function(a,b){"use strict";function c(a,b,c,g,j){function l(a,b){return q.then(function(){o||a()},function(a){o||b(a)})}function m(){o=w.cancelled=!0}var n,o,p,q,r=[],s=a&&a.state,t=b.state,u=b.params,v=s==t,w={from:s,to:t,toParams:u,then:l,cancel:m,cancelled:o,currentState:s};return s&&(n=g?t.root:f(s,t,v,c),r=h(s,n,v)),p=h(t,n,v).reverse(),k.newTransitionStarted(),q=d(v,g,c)?i("null"):e(p,r,u,w,v,j),w}function d(a,b,c){return a&&!b&&0==j.objectSize(c)}function e(a,b,c,d,e,f){function g(a,b){return function(e){if(h(),f.enabled){var g=b[0].toUpperCase()+b.slice(1);f.log(g+" "+a.fullName)}var i=a[b](c,e);return h(),void 0===i&&(i=e),d.currentState="exit"==b?a.parent:a,i}}function h(){if(d.cancelled)throw new Error("transition cancelled")}var j=i();return b.forEach(function(a){e&&a.update||(j=j.then(g(a,"exit")))}),a.forEach(function(a){var b=e&&a.update?"update":"enter";j=j.then(g(a,b))}),j}function f(a,b,c,d){var e,f,g;if(c)[a].concat(a.parents).reverse().forEach(function(a){if(!e)for(g in d)if(a.params[g]||a.queryParams[g]){e=a;break}});else for(var h=0;h<a.parents.length;h++)if(f=a.parents[h],b.parents.indexOf(f)>-1){e=f;break}return e}function g(a,b,c){var d=a.parents,e=Math.min(d.length,d.indexOf(b)+(c?1:0));return[a].concat(d.slice(0,e))}function h(a,b,c){var d=!b||c;return g(a,b||a.root,d)}var i=a("q"),j=a("./util"),k=c.asyncPromises=function(){function a(a){var b=i.defer();return d.push(b),i(a).then(function(a){d.indexOf(b)>-1&&b.resolve(a)},function(a){d.indexOf(b)>-1&&b.reject(a)}),b.promise}function b(){d.length=0}var c,d=[];return c={register:a,newTransitionStarted:b}}();b.exports=c},{"./util":8,q:1}],6:[function(a,b){"use strict";function c(a){i=(a||window.event).button;var b=e(a);void 0!==b&&j.state(b)}function d(a){var b=e(a);void 0!==b&&(a.preventDefault?a.preventDefault():a.returnValue=!1,j.state(b))}function e(a){a=a||window.event;var b="defaultPrevented"in a?a.defaultPrevented:a.returnValue===!1;if(!(b||a.metaKey||a.ctrlKey)&&f(a)){var c=a.target||a.srcElement,d=g(c);if(d){var e=d.getAttribute("data-nav");if("ignore"!=e&&("mousedown"!=a.type||"mousedown"==e)){var i=d.getAttribute("href");if(i&&"#"!=i.charAt(0)&&"_blank"!=d.getAttribute("target")&&h(d))return"click"==a.type&&"mousedown"==e?(a.preventDefault?a.preventDefault():a.returnValue=!1,void 0):i}}}}function f(a){a=a||window.event;var b=void 0!==a.which?a.which:i;return 1==b}function g(a){for(;a;){if("A"==a.nodeName)return a;a=a.parentNode}}function h(a){var b=a.hostname,c=a.port;if(!b){var d=document.createElement("a");d.href=a.href,b=d.hostname,c=d.port}var e=b==location.hostname,f=(c||"80")==(location.port||"80");return e&&f}var i,j;b.exports=function(a){j=a,document.addEventListener?(document.addEventListener("mousedown",c),document.addEventListener("click",d)):(document.attachEvent("onmousedown",c),document.attachEvent("onclick",d))}},{}],7:[function(a,b){"use strict";var c={Router:a("./Router"),State:a("./State"),Async:a("./Transition").asyncPromises.register,util:a("./util")};b.exports=c},{"./Router":2,"./State":3,"./Transition":5,"./util":8}],8:[function(a,b){"use strict";function c(a){return"[object String]"==Object.prototype.toString.call(a)}function d(){}function e(a){return a.reduce(function(a,b){return a[b]=1,a},{})}function f(a){var b=[];for(var c in a)b.push(a[c]);return b}function g(a){var b={};for(var c in a)b[c]=a[c];return b}function h(a,b){for(var c in b)a[c]=b[c]}function i(a){var b=0;for(var c in a)b++;return b}function j(){for(var a=arguments[0],b=Array.prototype.slice.call(arguments,1),c=0,d=b.length;d>c;c++)a=a.replace("{"+c+"}",b[c]);return a}function k(a){return"/"+a.replace(l,"").replace(m,"$1").replace(n,"?")}var l=/^\/+/,m=/^([^?]*?)\/+$/,n=/\/+\?/;b.exports={isString:c,noop:d,arrayToObject:e,objectToArray:f,copyObject:g,mergeObjects:h,objectSize:i,makeMessage:j,normalizePathQuery:k}},{}]},{},[7])(7)});